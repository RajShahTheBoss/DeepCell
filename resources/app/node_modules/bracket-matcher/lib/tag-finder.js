(function() {
  var Range, SelectorCache, SelfClosingTags, TagFinder, _;

  Range = require('atom').Range;

  _ = require('underscore-plus');

  SelectorCache = require('./selector-cache');

  SelfClosingTags = require('./self-closing-tags');

  module.exports = TagFinder = (function() {
    function TagFinder(editor) {
      this.editor = editor;
      this.tagPattern = /(<(\/?))([^\s>]+)([\s>]|$)/;
      this.wordRegex = /[^>\r\n]*/;
      this.tagSelector = SelectorCache.get('meta.tag | punctuation.definition.tag');
      this.commentSelector = SelectorCache.get('comment.*');
    }

    TagFinder.prototype.patternForTagName = function(tagName) {
      tagName = _.escapeRegExp(tagName);
      return new RegExp("(<" + tagName + "([\\s>]|$))|(</" + tagName + ">)", 'gi');
    };

    TagFinder.prototype.isRangeCommented = function(range) {
      var scopes;
      scopes = this.editor.scopeDescriptorForBufferPosition(range.start).getScopesArray();
      return this.commentSelector.matches(scopes);
    };

    TagFinder.prototype.isTagRange = function(range) {
      var scopes;
      scopes = this.editor.scopeDescriptorForBufferPosition(range.start).getScopesArray();
      return this.tagSelector.matches(scopes);
    };

    TagFinder.prototype.isCursorOnTag = function() {
      return this.tagSelector.matches(this.editor.getLastCursor().getScopeDescriptor().getScopesArray());
    };

    TagFinder.prototype.findStartTag = function(tagName, endPosition) {
      var pattern, scanRange, startRange, unpairedCount;
      scanRange = new Range([0, 0], endPosition);
      pattern = this.patternForTagName(tagName);
      startRange = null;
      unpairedCount = 0;
      this.editor.backwardsScanInBufferRange(pattern, scanRange, (function(_this) {
        return function(arg) {
          var match, range, stop;
          match = arg.match, range = arg.range, stop = arg.stop;
          if (_this.isRangeCommented(range)) {
            return;
          }
          if (match[1]) {
            unpairedCount--;
            if (unpairedCount < 0) {
              startRange = range.translate([0, 1], [0, -match[2].length]);
              return stop();
            }
          } else {
            return unpairedCount++;
          }
        };
      })(this));
      return startRange;
    };

    TagFinder.prototype.findEndTag = function(tagName, startPosition) {
      var endRange, pattern, scanRange, unpairedCount;
      scanRange = new Range(startPosition, this.editor.buffer.getEndPosition());
      pattern = this.patternForTagName(tagName);
      endRange = null;
      unpairedCount = 0;
      this.editor.scanInBufferRange(pattern, scanRange, (function(_this) {
        return function(arg) {
          var match, range, stop;
          match = arg.match, range = arg.range, stop = arg.stop;
          if (_this.isRangeCommented(range)) {
            return;
          }
          if (match[1]) {
            return unpairedCount++;
          } else {
            unpairedCount--;
            if (unpairedCount < 0) {
              endRange = range.translate([0, 2], [0, -1]);
              return stop();
            }
          }
        };
      })(this));
      return endRange;
    };

    TagFinder.prototype.findStartEndTags = function() {
      var endPosition, ranges;
      ranges = null;
      endPosition = this.editor.getLastCursor().getCurrentWordBufferRange({
        wordRegex: this.wordRegex
      }).end;
      this.editor.backwardsScanInBufferRange(this.tagPattern, [[0, 0], endPosition], (function(_this) {
        return function(arg) {
          var endRange, entireMatch, isClosingTag, match, prefix, range, startRange, stop, suffix, tagName;
          match = arg.match, range = arg.range, stop = arg.stop;
          stop();
          entireMatch = match[0], prefix = match[1], isClosingTag = match[2], tagName = match[3], suffix = match[4];
          if (range.start.row === range.end.row) {
            startRange = range.translate([0, prefix.length], [0, -suffix.length]);
          } else {
            startRange = Range.fromObject([range.start.translate([0, prefix.length]), [range.start.row, 2e308]]);
          }
          if (isClosingTag) {
            endRange = _this.findStartTag(tagName, startRange.start);
          } else {
            endRange = _this.findEndTag(tagName, startRange.end);
          }
          if ((startRange != null) && (endRange != null)) {
            return ranges = {
              startRange: startRange,
              endRange: endRange
            };
          }
        };
      })(this));
      return ranges;
    };

    TagFinder.prototype.findEnclosingTags = function() {
      var ranges;
      if (ranges = this.findStartEndTags()) {
        if (this.isTagRange(ranges.startRange) && this.isTagRange(ranges.endRange)) {
          return ranges;
        }
      }
      return null;
    };

    TagFinder.prototype.findMatchingTags = function() {
      if (this.isCursorOnTag()) {
        return this.findStartEndTags();
      }
    };

    TagFinder.prototype.parseFragment = function(fragment, stack, matchExpr, cond) {
      var match, topElem;
      match = fragment.match(matchExpr);
      while (match && cond(stack)) {
        if (SelfClosingTags.indexOf(match[1]) === -1) {
          topElem = stack[stack.length - 1];
          if (match[2] && topElem === match[2]) {
            stack.pop();
          } else if (match[1]) {
            stack.push(match[1]);
          }
        }
        fragment = fragment.substr(match.index + match[0].length);
        match = fragment.match(matchExpr);
      }
      return stack;
    };

    TagFinder.prototype.tagsNotClosedInFragment = function(fragment) {
      return this.parseFragment(fragment, [], /<(\w[-\w]*(?:\:\w[-\w]*)?)|<\/(\w[-\w]*(?:\:\w[-\w]*)?)/, function() {
        return true;
      });
    };

    TagFinder.prototype.tagDoesNotCloseInFragment = function(tags, fragment) {
      var escapedTag, matchExpr, stack, stackLength, tag;
      if (tags.length === 0) {
        return false;
      }
      stack = tags;
      stackLength = stack.length;
      tag = tags[tags.length - 1];
      escapedTag = _.escapeRegExp(tag);
      matchExpr = new RegExp("<(" + escapedTag + ")|<\/(" + escapedTag + ")");
      stack = this.parseFragment(fragment, stack, matchExpr, function(s) {
        return s.length >= stackLength || s[s.length - 1] === tag;
      });
      return stack.length > 0 && stack[stack.length - 1] === tag;
    };

    TagFinder.prototype.closingTagForFragments = function(preFragment, postFragment) {
      var tag, tags;
      tags = this.tagsNotClosedInFragment(preFragment);
      tag = tags[tags.length - 1];
      if (this.tagDoesNotCloseInFragment(tags, postFragment)) {
        return tag;
      } else {
        return null;
      }
    };

    return TagFinder;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmlsZTovLy9DOi9wcm9qZWN0cy9hdG9tL291dC9hcHAvbm9kZV9tb2R1bGVzL2JyYWNrZXQtbWF0Y2hlci9saWIvdGFnLWZpbmRlci5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxNQUFBOztFQUFDLFFBQVMsT0FBQSxDQUFRLE1BQVI7O0VBQ1YsQ0FBQSxHQUFJLE9BQUEsQ0FBUSxpQkFBUjs7RUFDSixhQUFBLEdBQWdCLE9BQUEsQ0FBUSxrQkFBUjs7RUFDaEIsZUFBQSxHQUFrQixPQUFBLENBQVEscUJBQVI7O0VBSWxCLE1BQU0sQ0FBQyxPQUFQLEdBQ007SUFDUyxtQkFBQyxNQUFEO01BQUMsSUFBQyxDQUFBLFNBQUQ7TUFDWixJQUFDLENBQUEsVUFBRCxHQUFjO01BQ2QsSUFBQyxDQUFBLFNBQUQsR0FBYTtNQUNiLElBQUMsQ0FBQSxXQUFELEdBQWUsYUFBYSxDQUFDLEdBQWQsQ0FBa0IsdUNBQWxCO01BQ2YsSUFBQyxDQUFBLGVBQUQsR0FBbUIsYUFBYSxDQUFDLEdBQWQsQ0FBa0IsV0FBbEI7SUFKUjs7d0JBTWIsaUJBQUEsR0FBbUIsU0FBQyxPQUFEO01BQ2pCLE9BQUEsR0FBVSxDQUFDLENBQUMsWUFBRixDQUFlLE9BQWY7YUFDTixJQUFBLE1BQUEsQ0FBTyxJQUFBLEdBQUssT0FBTCxHQUFhLGlCQUFiLEdBQThCLE9BQTlCLEdBQXNDLElBQTdDLEVBQWtELElBQWxEO0lBRmE7O3dCQUluQixnQkFBQSxHQUFrQixTQUFDLEtBQUQ7QUFDaEIsVUFBQTtNQUFBLE1BQUEsR0FBUyxJQUFDLENBQUEsTUFBTSxDQUFDLGdDQUFSLENBQXlDLEtBQUssQ0FBQyxLQUEvQyxDQUFxRCxDQUFDLGNBQXRELENBQUE7YUFDVCxJQUFDLENBQUEsZUFBZSxDQUFDLE9BQWpCLENBQXlCLE1BQXpCO0lBRmdCOzt3QkFJbEIsVUFBQSxHQUFZLFNBQUMsS0FBRDtBQUNWLFVBQUE7TUFBQSxN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QUE7ZUFHRSxLQUhGOztJQUhzQjs7Ozs7QUE3SjFCIiwic291cmNlc0NvbnRlbnQiOlsie1JhbmdlfSA9IHJlcXVpcmUgJ2F0b20nXG5fID0gcmVxdWlyZSAndW5kZXJzY29yZS1wbHVzJ1xuU2VsZWN0b3JDYWNoZSA9IHJlcXVpcmUgJy4vc2VsZWN0b3ItY2FjaGUnXG5TZWxmQ2xvc2luZ1RhZ3MgPSByZXF1aXJlICcuL3NlbGYtY2xvc2luZy10YWdzJ1xuXG4jIEhlbHBlciB0byBmaW5kIHRoZSBtYXRjaGluZyBzdGFydC9lbmQgdGFnIGZvciB0aGUgc3RhcnQvZW5kIHRhZyB1bmRlciB0aGVcbiMgY3Vyc29yIGluIFhNTCwgSFRNTCwgZXRjLiBlZGl0b3JzLlxubW9kdWxlLmV4cG9ydHMgPVxuY2xhc3MgVGFnRmluZGVyXG4gIGNvbnN0cnVjdG9yOiAoQGVkaXRvcikgLT5cbiAgICBAdGFnUGF0dGVybiA9IC8oPChcXC8/KSkoW15cXHM+XSspKFtcXHM+XXwkKS9cbiAgICBAd29yZFJlZ2V4ID0gL1tePlxcclxcbl0qL1xuICAgIEB0YWdTZWxlY3RvciA9IFNlbGVjdG9yQ2FjaGUuZ2V0KCdtZXRhLnRhZyB8IHB1bmN0dWF0aW9uLmRlZmluaXRpb24udGFnJylcbiAgICBAY29tbWVudFNlbGVjdG9yID0gU2VsZWN0b3JDYWNoZS5nZXQoJ2NvbW1lbnQuKicpXG5cbiAgcGF0dGVybkZvclRhZ05hbWU6ICh0YWdOYW1lKSAtPlxuICAgIHRhZ05hbWUgPSBfLmVzY2FwZVJlZ0V4cCh0YWdOYW1lKVxuICAgIG5ldyBSZWdFeHAoXCIoPCN7dGFnTmFtZX0oW1xcXFxzPl18JCkpfCg8LyN7dGFnTmFtZX0+KVwiLCAnZ2knKVxuXG4gIGlzUmFuZ2VDb21tZW50ZWQ6IChyYW5nZSkgLT5cbiAgICBzY29wZXMgPSBAZWRpdG9yLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHJhbmdlLnN0YXJ0KS5nZXRTY29wZXNBcnJheSgpXG4gICAgQGNvbW1lbnRTZWxlY3Rvci5tYXRjaGVzKHNjb3BlcylcblxuICBpc1RhZ1JhbmdlOiAocmFuZ2UpIC0+XG4gICAgc2NvcGVzID0gQGVkaXRvci5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihyYW5nZS5zdGFydCkuZ2V0U2NvcGVzQXJyYXkoKVxuICAgIEB0YWdTZWxlY3Rvci5tYXRjaGVzKHNjb3BlcylcblxuICBpc0N1cnNvck9uVGFnOiAtPlxuICAgIEB0YWdTZWxlY3Rvci5tYXRjaGVzKEBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldFNjb3BlRGVzY3JpcHRvcigpLmdldFNjb3Blc0FycmF5KCkpXG5cbiAgZmluZFN0YXJ0VGFnOiAodGFnTmFtZSwgZW5kUG9zaXRpb24pIC0+XG4gICAgc2NhblJhbmdlID0gbmV3IFJhbmdlKFswLCAwXSwgZW5kUG9zaXRpb24pXG4gICAgcGF0dGVybiA9IEBwYXR0ZXJuRm9yVGFnTmFtZSh0YWdOYW1lKVxuICAgIHN0YXJ0UmFuZ2UgPSBudWxsXG4gICAgdW5wYWlyZWRDb3VudCA9IDBcbiAgICBAZWRpdG9yLmJhY2t3YXJkc1NjYW5JbkJ1ZmZlclJhbmdlIHBhdHRlcm4sIHNjYW5SYW5nZSwgKHttYXRjaCwgcmFuZ2UsIHN0b3B9KSA9PlxuICAgICAgcmV0dXJuIGlmIEBpc1JhbmdlQ29tbWVudGVkKHJhbmdlKVxuXG4gICAgICBpZiBtYXRjaFsxXVxuICAgICAgICB1bnBhaXJlZENvdW50LS1cbiAgICAgICAgaWYgdW5wYWlyZWRDb3VudCA8IDBcbiAgICAgICAgICBzdGFydFJhbmdlID0gcmFuZ2UudHJhbnNsYXRlKFswLCAxXSwgWzAsIC1tYXRjaFsyXS5sZW5ndGhdKSAjIFN1YnRyYWN0IDwgYW5kIHRhZyBuYW1lIHN1ZmZpeCBmcm9tIHJhbmdlXG4gICAgICAgICAgc3RvcCgpXG4gICAgICBlbHNlXG4gICAgICAgIHVucGFpcmVkQ291bnQrK1xuXG4gICAgc3RhcnRSYW5nZVxuXG4gIGZpbmRFbmRUYWc6ICh0YWdOYW1lLCBzdGFydFBvc2l0aW9uKSAtPlxuICAgIHNjYW5SYW5nZSA9IG5ldyBSYW5nZShzdGFydFBvc2l0aW9uLCBAZWRpdG9yLmJ1ZmZlci5nZXRFbmRQb3NpdGlvbigpKVxuICAgIHBhdHRlcm4gPSBAcGF0dGVybkZvclRhZ05hbWUodGFnTmFtZSlcbiAgICBlbmRSYW5nZSA9IG51bGxcbiAgICB1bnBhaXJlZENvdW50ID0gMFxuICAgIEBlZGl0b3Iuc2NhbkluQnVmZmVyUmFuZ2UgcGF0dGVybiwgc2NhblJhbmdlLCAoe21hdGNoLCByYW5nZSwgc3RvcH0pID0+XG4gICAgICByZXR1cm4gaWYgQGlzUmFuZ2VDb21tZW50ZWQocmFuZ2UpXG5cbiAgICAgIGlmIG1hdGNoWzFdXG4gICAgICAgIHVucGFpcmVkQ291bnQrK1xuICAgICAgZWxzZVxuICAgICAgICB1bnBhaXJlZENvdW50LS1cbiAgICAgICAgaWYgdW5wYWlyZWRDb3VudCA8IDBcbiAgICAgICAgICBlbmRSYW5nZSA9IHJhbmdlLnRyYW5zbGF0ZShbMCwgMl0sIFswLCAtMV0pICMgU3VidHJhY3QgPC8gYW5kID4gZnJvbSByYW5nZVxuICAgICAgICAgIHN0b3AoKVxuXG4gICAgZW5kUmFuZ2VcblxuICBmaW5kU3RhcnRFbmRUYWdzOiAtPlxuICAgIHJhbmdlcyA9IG51bGxcbiAgICBlbmRQb3NpdGlvbiA9IEBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldEN1cnJlbnRXb3JkQnVmZmVyUmFuZ2Uoe0B3b3JkUmVnZXh9KS5lbmRcbiAgICBAZWRpdG9yLmJhY2t3YXJkc1NjYW5JbkJ1ZmZlclJhbmdlIEB0YWdQYXR0ZXJuLCBbWzAsIDBdLCBlbmRQb3NpdGlvbl0sICh7bWF0Y2gsIHJhbmdlLCBzdG9wfSkgPT5cbiAgICAgIHN0b3AoKVxuXG4gICAgICBbZW50aXJlTWF0Y2gsIHByZWZpeCwgaXNDbG9zaW5nVGFnLCB0YWdOYW1lLCBzdWZmaXhdID0gbWF0Y2hcblxuICAgICAgaWYgcmFuZ2Uuc3RhcnQucm93IGlzIHJhbmdlLmVuZC5yb3dcbiAgICAgICAgc3RhcnRSYW5nZSA9IHJhbmdlLnRyYW5zbGF0ZShbMCwgcHJlZml4Lmxlbmd0aF0sIFswLCAtc3VmZml4Lmxlbmd0aF0pXG4gICAgICBlbHNlXG4gICAgICAgIHN0YXJ0UmFuZ2UgPSBSYW5nZS5mcm9tT2JqZWN0KFtyYW5nZS5zdGFydC50cmFuc2xhdGUoWzAsIHByZWZpeC5sZW5ndGhdKSwgW3JhbmdlLnN0YXJ0LnJvdywgSW5maW5pdHldXSlcblxuICAgICAgaWYgaXNDbG9zaW5nVGFnXG4gICAgICAgIGVuZFJhbmdlID0gQGZpbmRTdGFydFRhZyh0YWdOYW1lLCBzdGFydFJhbmdlLnN0YXJ0KVxuICAgICAgZWxzZVxuICAgICAgICBlbmRSYW5nZSA9IEBmaW5kRW5kVGFnKHRhZ05hbWUsIHN0YXJ0UmFuZ2UuZW5kKVxuXG4gICAgICByYW5nZXMgPSB7c3RhcnRSYW5nZSwgZW5kUmFuZ2V9IGlmIHN0YXJ0UmFuZ2U/IGFuZCBlbmRSYW5nZT9cbiAgICByYW5nZXNcblxuICBmaW5kRW5jbG9zaW5nVGFnczogLT5cbiAgICBpZiByYW5nZXMgPSBAZmluZFN0YXJ0RW5kVGFncygpXG4gICAgICBpZiBAaXNUYWdSYW5nZShyYW5nZXMuc3RhcnRSYW5nZSkgYW5kIEBpc1RhZ1JhbmdlKHJhbmdlcy5lbmRSYW5nZSlcbiAgICAgICAgcmV0dXJuIHJhbmdlc1xuXG4gICAgbnVsbFxuXG4gIGZpbmRNYXRjaGluZ1RhZ3M6IC0+XG4gICAgQGZpbmRTdGFydEVuZFRhZ3MoKSBpZiBAaXNDdXJzb3JPblRhZygpXG5cbiAgIyBQYXJzZXMgYSBmcmFnbWVudCBvZiBodG1sIHJldHVybmluZyB0aGUgc3RhY2sgKGkuZS4sIGFuIGFycmF5KSBvZiBvcGVuIHRhZ3NcbiAgI1xuICAjIGZyYWdtZW50ICAtIHRoZSBmcmFnbWVudCBvZiBodG1sIHRvIGJlIGFuYWx5c2VkXG4gICMgc3RhY2sgICAgIC0gYW4gYXJyYXkgdG8gYmUgcG9wdWxhdGVkIChjYW4gYmUgbm9uLWVtcHR5KVxuICAjIG1hdGNoRXhwciAtIGEgUmVnRXhwIGRlc2NyaWJpbmcgaG93IHRvIG1hdGNoIG9wZW5pbmcvY2xvc2luZyB0YWdzXG4gICMgICAgICAgICAgICAgdGhlIG9wZW5pbmcvY2xvc2luZyBkZXNjcmlwdGlvbnMgbXVzdCBiZSBjYXB0dXJlZCBzdWJleHByZXNzaW9uc1xuICAjICAgICAgICAgICAgIHNvIHRoYXQgdGhlIGNvZGUgY2FuIHJlZmVyIHRvIG1hdGNoWzFdIHRvIGNoZWNrIGlmIGFuIG9wZW5pbmdcbiAgIyAgICAgICAgICAgICB0YWcgaGFzIGJlZW4gZm91bmQsIGFuZCB0byBtYXRjaFsyXSB0byBjaGVjayBpZiBhIGNsb3NpbmcgdGFnXG4gICMgICAgICAgICAgICAgaGFzIGJlZW4gZm91bmRcbiAgIyBjb25kICAgICAgLSBhIGNvbmRpdGlvbiB0byBiZSBjaGVja2VkIGF0IGVhY2ggaXRlcmF0aW9uLiBJZiB0aGUgZnVuY3Rpb25cbiAgIyAgICAgICAgICAgICByZXR1cm5zIGZhbHNlIHRoZSBwcm9jZXNzaW5nIGlzIGltbWVkaWF0ZWx5IGludGVycnVwdGVkLiBXaGVuXG4gICMgICAgICAgICAgICAgY2FsbGVkIHRoZSBjdXJyZW50IHN0YWNrIGlzIHByb3ZpZGVkIHRvIHRoZSBmdW5jdGlvbi5cbiAgI1xuICAjIFJldHVybnMgYW4gYXJyYXkgb2Ygc3RyaW5ncy4gRWFjaCBzdHJpbmcgaXMgYSB0YWcgdGhhdCBpcyBzdGlsbCB0byBiZSBjbG9zZWRcbiAgIyAodGhlIG1vc3QgcmVjZW50IG5vbiBjbG9zZWQgdGFnIGlzIGF0IHRoZSBlbmQgb2YgdGhlIGFycmF5KS5cbiAgcGFyc2VGcmFnbWVudDogKGZyYWdtZW50LCBzdGFjaywgbWF0Y2hFeHByLCBjb25kKSAtPlxuICAgIG1hdGNoID0gZnJhZ21lbnQubWF0Y2gobWF0Y2hFeHByKVxuICAgIHdoaWxlIG1hdGNoIGFuZCBjb25kKHN0YWNrKVxuICAgICAgaWYgU2VsZkNsb3NpbmdUYWdzLmluZGV4T2YobWF0Y2hbMV0pIGlzIC0xXG4gICAgICAgIHRvcEVsZW0gPSBzdGFja1tzdGFjay5sZW5ndGgtMV1cblxuICAgICAgICBpZiBtYXRjaFsyXSBhbmQgdG9wRWxlbSBpcyBtYXRjaFsyXVxuICAgICAgICAgIHN0YWNrLnBvcCgpXG4gICAgICAgIGVsc2UgaWYgbWF0Y2hbMV1cbiAgICAgICAgICBzdGFjay5wdXNoIG1hdGNoWzFdXG5cbiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQuc3Vic3RyKG1hdGNoLmluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoKVxuICAgICAgbWF0Y2ggPSBmcmFnbWVudC5tYXRjaChtYXRjaEV4cHIpXG5cbiAgICBzdGFja1xuXG4gICMgUGFyc2VzIHRoZSBnaXZlbiBmcmFnbWVudCBvZiBodG1sIGNvZGUgcmV0dXJuaW5nIHRoZSBsYXN0IHVuY2xvc2VkIHRhZy5cbiAgI1xuICAjIGZyYWdtZW50IC0gYSBzdHJpbmcgY29udGFpbmluZyBhIGZyYWdtZW50IG9mIGh0bWwgY29kZS5cbiAgI1xuICAjIFJldHVybnMgYSBzdHJpbmcgd2l0aCB0aGUgbmFtZSBvZiB0aGUgbW9zdCByZWNlbnQgdW5jbG9zZWQgdGFnLlxuICB0YWdzTm90Q2xvc2VkSW5GcmFnbWVudDogKGZyYWdtZW50KSAtPlxuICAgIEBwYXJzZUZyYWdtZW50IGZyYWdtZW50LCBbXSwgLzwoXFx3Wy1cXHddKig/OlxcOlxcd1stXFx3XSopPyl8PFxcLyhcXHdbLVxcd10qKD86XFw6XFx3Wy1cXHddKik/KS8sIC0+IHRydWVcblxuICAjIFBhcnNlcyB0aGUgZ2l2ZW4gZnJhZ21lbnQgb2YgaHRtbCBjb2RlIGFuZCByZXR1cm5zIHRydWUgaWYgdGhlIGdpdmVuIHRhZ1xuICAjIGhhcyBhIG1hdGNoaW5nIGNsb3NpbmcgdGFnIGluIGl0LiBJZiB0YWcgaXMgcmVvcGVuZWQgYW5kIHJlY2xvc2VkIGluIHRoZVxuICAjIGdpdmVuIGZyYWdtZW50IHRoZW4gdGhlIGVuZCBwb2ludCBvZiB0aGF0IHBhaXIgZG9lcyBub3QgY291bnQgYXMgYSBtYXRjaGluZ1xuICAjIGNsb3NpbmcgdGFnLlxuICB0YWdEb2VzTm90Q2xvc2VJbkZyYWdtZW50OiAodGFncywgZnJhZ21lbnQpIC0+XG4gICAgcmV0dXJuIGZhbHNlIGlmIHRhZ3MubGVuZ3RoIGlzIDBcblxuICAgIHN0YWNrID0gdGFnc1xuICAgIHN0YWNrTGVuZ3RoID0gc3RhY2subGVuZ3RoXG4gICAgdGFnID0gdGFnc1t0YWdzLmxlbmd0aC0xXVxuICAgIGVzY2FwZWRUYWcgPSBfLmVzY2FwZVJlZ0V4cCh0YWcpXG4gICAgbWF0Y2hFeHByID0gbmV3IFJlZ0V4cChcIjwoI3tlc2NhcGVkVGFnfSl8PFxcLygje2VzY2FwZWRUYWd9KVwiKVxuICAgIHN0YWNrID0gQHBhcnNlRnJhZ21lbnQgZnJhZ21lbnQsIHN0YWNrLCBtYXRjaEV4cHIsIChzKSAtPlxuICAgICAgcy5sZW5ndGggPj0gc3RhY2tMZW5ndGggb3Igc1tzLmxlbmd0aC0xXSBpcyB0YWdcblxuICAgIHN0YWNrLmxlbmd0aCA+IDAgYW5kIHN0YWNrW3N0YWNrLmxlbmd0aC0xXSBpcyB0YWdcblxuICAjIFBhcnNlcyBwcmVGcmFnbWVudCBhbmQgcG9zdEZyYWdtZW50IHJldHVybmluZyB0aGUgbGFzdCBvcGVuIHRhZyBpblxuICAjIHByZUZyYWdtZW50IHRoYXQgaXMgbm90IGNsb3NlZCBpbiBwb3N0RnJhZ21lbnQuXG4gICNcbiAgIyBSZXR1cm5zIGEgdGFnIG5hbWUgb3IgbnVsbCBpZiBpdCBjYW4ndCBmaW5kIGl0LlxuICBjbG9zaW5nVGFnRm9yRnJhZ21lbnRzOiAocHJlRnJhZ21lbnQsIHBvc3RGcmFnbWVudCkgLT5cbiAgICB0YWdzID0gQHRhZ3NOb3RDbG9zZWRJbkZyYWdtZW50KHByZUZyYWdtZW50KVxuICAgIHRhZyA9IHRhZ3NbdGFncy5sZW5ndGgtMV1cbiAgICBpZiBAdGFnRG9lc05vdENsb3NlSW5GcmFnbWVudCh0YWdzLCBwb3N0RnJhZ21lbnQpXG4gICAgICB0YWdcbiAgICBlbHNlXG4gICAgICBudWxsXG4iXX0=
