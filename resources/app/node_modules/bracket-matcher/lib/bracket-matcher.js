(function() {
  var BracketMatcher, CompositeDisposable, SelectorCache, _,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  _ = require('underscore-plus');

  CompositeDisposable = require('atom').CompositeDisposable;

  SelectorCache = require('./selector-cache');

  module.exports = BracketMatcher = (function() {
    function BracketMatcher(editor, editorElement, matchManager) {
      this.editor = editor;
      this.matchManager = matchManager;
      this.backspace = bind(this.backspace, this);
      this.insertNewline = bind(this.insertNewline, this);
      this.insertText = bind(this.insertText, this);
      this.subscriptions = new CompositeDisposable;
      this.bracketMarkers = [];
      _.adviseBefore(this.editor, 'insertText', this.insertText);
      _.adviseBefore(this.editor, 'insertNewline', this.insertNewline);
      _.adviseBefore(this.editor, 'backspace', this.backspace);
      this.subscriptions.add(atom.commands.add(editorElement, 'bracket-matcher:remove-brackets-from-selection', (function(_this) {
        return function(event) {
          if (!_this.removeBrackets()) {
            return event.abortKeyBinding();
          }
        };
      })(this)));
      this.subscriptions.add(this.editor.onDidDestroy((function(_this) {
        return function() {
          return _this.unsubscribe();
        };
      })(this)));
    }

    BracketMatcher.prototype.insertText = function(text, options) {
      var autoCompleteOpeningBracket, bracketMarker, cursorBufferPosition, hasEscapeCharacterBeforeCursor, hasEscapeSequenceBeforeCursor, hasQuoteBeforeCursor, hasWordAfterCursor, hasWordBeforeCursor, nextCharacter, pair, previousCharacter, previousCharacters, range, ref, ref1, ref2, skipOverExistingClosingBracket;
      if (!text) {
        return true;
      }
      if ((options != null ? options.select : void 0) || (options != null ? options.undo : void 0) === 'skip') {
        return true;
      }
      if (this.wrapSelectionInBrackets(text)) {
        return false;
      }
      if (this.editor.hasMultipleCursors()) {
        return true;
      }
      cursorBufferPosition = this.editor.getCursorBufferPosition();
      previousCharacters = this.editor.getTextInBufferRange([[cursorBufferPosition.row, 0], cursorBufferPosition]);
      nextCharacter = this.editor.getTextInBufferRange([cursorBufferPosition, cursorBufferPosition.traverse([0, 1])]);
      previousCharacter = previousCharacters.slice(-1);
      hasWordAfterCursor = /\w/.test(nextCharacter);
      hasWordBeforeCursor = /\w/.test(previousCharacter);
      hasQuoteBeforeCursor = this.isQuote(previousCharacter) && previousCharacter === text[0];
      hasEscapeCharacterBeforeCursor = ((ref = previousCharacters.match(/(\\+)$/)) != null ? ref[1].length : void 0) % 2 === 1;
      hasEscapeSequenceBeforeCursor = ((ref1 = previousCharacters.match(/(\\+)[^\\]$/)) != null ? ref1[1].length : void 0) % 2 === 1 || ((ref2 = previousCharacters.match(/(\\+)$/)) != null ? ref2[1].length : void 0) % 2 === 0;
      if (text === '#' && this.isCursorOnInterpolatedString()) {
        autoCompleteOpeningBracket = this.getScopedSetting('bracket-matcher.autocompleteBrackets') && !hasEscapeCharacterBeforeCursor;
        text += '{';
        pair = '}';
      } else {
        autoCompleteOpeningBracket = this.getScopedSetting('bracket-matcher.autocompleteBrackets') && this.isOpeningBracket(text) && !hasWordAfterCursor && !(this.isQuote(text) && (hasWordBeforeCursor || hasQuoteBeforeCursor || hasEscapeSequenceBeforeCursor)) && !hasEscapeCharacterBeforeCursor;
        pair = this.matchManager.pairedCharacters[text];
      }
      skipOverExistingClosingBracket = false;
      if (this.isClosingBracket(text) && nextCharacter === text && !hasEscapeCharacterBeforeCursor) {
        if (bracketMarker = _.find(this.bracketMarkers, function(marker) {
          return marker.isValid() && marker.getBufferRange().end.isEqual(cursorBufferPosition);
        })) {
          skipOverExistingClosingBracket = true;
        }
      }
      if (skipOverExistingClosingBracket) {
        bracketMarker.destroy();
        _.remove(this.bracketMarkers, bracketMarker);
        this.editor.moveRight();
        return false;
      } else if (autoCompleteOpeningBracket) {
        this.editor.insertText(text + pair);
        this.editor.moveLeft();
        range = [cursorBufferPosition, cursorBufferPosition.traverse([0, text.length])];
        this.bracketMarkers.push(this.editor.markBufferRange(range));
        return false;
      }
    };

    BracketMatcher.prototype.insertNewline = function() {
      var cursorBufferPosition, hasEscapeCharacterBeforeCursor, nextCharacter, previousCharacter, previousCharacters, ref;
      if (this.editor.hasMultipleCursors()) {
        return;
      }
      if (!this.editor.getLastSelection().isEmpty()) {
        return;
      }
      cursorBufferPosition = this.editor.getCursorBufferPosition();
      previousCharacters = this.editor.getTextInBufferRange([[cursorBufferPosition.row, 0], cursorBufferPosition]);
      nextCharacter = this.editor.getTextInBufferRange([cursorBufferPosition, cursorBufferPosition.traverse([0, 1])]);
      previousCharacter = previousCharacters.slice(-1);
      hasEscapeCharacterBeforeCursor = ((ref = previousCharacters.match(/(\\+)$/)) != null ? ref[1].length : void 0) % 2 === 1;
      if (this.matchManager.pairsWithExtraNewline[previousCharacter] === nextCharacter && !hasEscapeCharacterBeforeCursor) {
        this.editor.transact((function(_this) {
          return function() {
            var cursorRow;
            _this.editor.insertText("\n\n");
            _this.editor.moveUp();
            if (_this.getScopedSetting('editor.autoIndent')) {
              cursorRow = _this.editor.getCursorBufferPosition().row;
              return _this.editor.autoIndentBufferRows(cursorRow, cursorRow + 1);
            }
          };
        })(this));
        return false;
      }
    };

    BracketMatcher.prototype.backspace = function() {
      var cursorBufferPosition, hasEscapeCharacterBeforeCursor, nextCharacter, previousCharacter, previousCharacters, ref;
      if (this.editor.hasMultipleCursors()) {
        return;
      }
      if (!this.editor.getLastSelection().isEmpty()) {
        return;
      }
      cursorBufferPosition = this.editor.getCursorBufferPosition();
      previousCharacters = this.editor.getTextInBufferRange([[cursorBufferPosition.row, 0], cursorBufferPosition]);
      nextCharacter = this.editor.getTextInBufferRange([cursorBufferPosition, cursorBufferPosition.traverse([0, 1])]);
      previousCharacter = previousCharacters.slice(-1);
      hasEscapeCharacterBeforeCursor = ((ref = previousCharacters.match(/(\\+)$/)) != null ? ref[1].length : void 0) % 2 === 1;
      if ((this.matchManager.pairedCharacters[previousCharacter] === nextCharacter) && !hasEscapeCharacterBeforeCursor && this.getScopedSetting('bracket-matcher.autocompleteBrackets')) {
        this.editor.transact((function(_this) {
          return function() {
            _this.editor.moveLeft();
            _this.editor["delete"]();
            return _this.editor["delete"]();
          };
        })(this));
        return false;
      }
    };

    BracketMatcher.prototype.removeBrackets = function() {
      var bracketsRemoved;
      bracketsRemoved = false;
      this.editor.mutateSelectedText((function(_this) {
        return function(selection) {
          var options, range, selectionEnd, selectionStart, text;
          if (!_this.selectionIsWrappedByMatchingBrackets(selection)) {
            return;
          }
          range = selection.getBufferRange();
          options = {
            reversed: selection.isReversed()
          };
          selectionStart = range.start;
          if (range.start.row === range.end.row) {
            selectionEnd = range.end.traverse([0, -2]);
          } else {
            selectionEnd = range.end.traverse([0, -1]);
          }
          text = selection.getText();
          selection.insertText(text.substring(1, text.length - 1));
          selection.setBufferRange([selectionStart, selectionEnd], options);
          return bracketsRemoved = true;
        };
      })(this));
      return bracketsRemoved;
    };

    BracketMatcher.prototype.wrapSelectionInBrackets = function(bracket) {
      var pair, selectionWrapped;
      if (!this.getScopedSetting('bracket-matcher.wrapSelectionsInBrackets')) {
        return false;
      }
      if (bracket === '#') {
        if (!this.isCursorOnInterpolatedString()) {
          return false;
        }
        bracket = '#{';
        pair = '}';
      } else {
        if (!this.isOpeningBracket(bracket)) {
          return false;
        }
        pair = this.matchManager.pairedCharacters[bracket];
      }
      selectionWrapped = false;
      this.editor.mutateSelectedText(function(selection) {
        var options, range, selectionEnd, selectionStart;
        if (selection.isEmpty()) {
          return;
        }
        if (bracket === '#{' && !selection.getBufferRange().isSingleLine()) {
          return;
        }
        selectionWrapped = true;
        range = selection.getBufferRange();
        options = {
          reversed: selection.isReversed()
        };
        selection.insertText("" + bracket + (selection.getText()) + pair);
        selectionStart = range.start.traverse([0, bracket.length]);
        if (range.start.row === range.end.row) {
          selectionEnd = range.end.traverse([0, bracket.length]);
        } else {
          selectionEnd = range.end;
        }
        return selection.setBufferRange([selectionStart, selectionEnd], options);
      });
      return selectionWrapped;
    };

    BracketMatcher.prototype.isQuote = function(string) {
      return /['"`]/.test(string);
    };

    BracketMatcher.prototype.isCursorOnInterpolatedString = function() {
      var segments;
      if (this.interpolatedStringSelector == null) {
        segments = ['*.*.*.interpolated.ruby', 'string.interpolated.ruby', 'string.regexp.interpolated.ruby', 'string.quoted.double.coffee', 'string.unquoted.heredoc.ruby', 'string.quoted.double.livescript', 'string.quoted.double.heredoc.livescript', 'string.quoted.double.elixir', 'string.quoted.double.heredoc.elixir', 'comment.documentation.heredoc.elixir'];
        this.interpolatedStringSelector = SelectorCache.get(segments.join(' | '));
      }
      return this.interpolatedStringSelector.matches(this.editor.getLastCursor().getScopeDescriptor().getScopesArray());
    };

    BracketMatcher.prototype.isOpeningBracket = function(string) {
      return this.matchManager.pairedCharacters.hasOwnProperty(string);
    };

    BracketMatcher.prototype.isClosingBracket = function(string) {
      return this.matchManager.pairedCharactersInverse.hasOwnProperty(string);
    };

    BracketMatcher.prototype.selectionIsWrappedByMatchingBrackets = function(selection) {
      var firstCharacter, lastCharacter, selectedText;
      if (selection.isEmpty()) {
        return false;
      }
      selectedText = selection.getText();
      firstCharacter = selectedText[0];
      lastCharacter = selectedText[selectedText.length - 1];
      return this.matchManager.pairedCharacters[firstCharacter] === lastCharacter;
    };

    BracketMatcher.prototype.unsubscribe = function() {
      return this.subscriptions.dispose();
    };

    BracketMatcher.prototype.getScopedSetting = function(key) {
      return atom.config.get(key, {
        scope: this.editor.getRootScopeDescriptor()
      });
    };

    return BracketMatcher;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmlsZTovLy9DOi9wcm9qZWN0cy9hdG9tL291dC9hcHAvbm9kZV9tb2R1bGVzL2JyYWNrZXQtbWF0Y2hlci9saWIvYnJhY2tldC1tYXRjaGVyLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEscURBQUE7SUFBQTs7RUFBQSxDQUFBLEdBQUksT0FBQSxDQUFRLGlCQUFSOztFQUNILHNCQUF1QixPQUFBLENBQVEsTUFBUjs7RUFDeEIsYUFBQSxHQUFnQixPQUFBLENBQVEsa0JBQVI7O0VBRWhCLE1BQU0sQ0FBQyxPQUFQLEdBQ007SUFDUyx3QkFBQyxNQUFELEVBQVUsYUFBVixFQUF5QixZQUF6QjtNQUFDLElBQUMsQ0FBQSxTQUFEO01BQXdCLElBQUMsQ0FBQSxlQUFEOzs7O01BQ3BDLElBQUMsQ0FBQSxhQUFELEdBQWlCLElBQUk7TUFDckIsSUFBQyxDQUFBLGNBQUQsR0FBa0I7TUFFbEIsQ0FBQyxDQUFDLFlBQUYsQ0FBZSxJQUFDLENBQUEsTUFBaEIsRUFBd0IsWUFBeEIsRUFBc0MsSUFBQyxDQUFBLFVBQXZDO01BQ0EsQ0FBQyxDQUFDLFlBQUYsQ0FBZSxJQUFDLENBQUEsTUFBaEIsRUFBd0IsZUFBeEIsRUFBeUMsSUFBQyxDQUFBLGFBQTFDO01BQ0EsQ0FBQyxDQUFDLFlBQUYsQ0FBZSxJQUFDLENBQUEsTUFBaEIsRUFBd0IsV0FBeEIsRUFBcUMsSUFBQyxDQUFBLFNBQXRDO01BRUEsSUFBQyxDQUFBLGFBQWEsQ0FBQyxHQUFmLENBQW1CLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBZCxDQUFrQixhQUFsQixFQUFpQyxnREFBakMsRUFBbUYsQ0FBQSxTQUFBLEtBQUE7ZUFBQSxTQUFDLEtBQUQ7VUFDcEcsSUFBQSxDQUErQixLQUFDLENBQUEsY0FBRCxDQUFBLENBQS9CO21CQUFBLEtBQUssQ0FBQyxlQUFOLENBQUEsRUFBQTs7UUFEb0c7TUFBQSxDQUFBLENBQUEsQ0FB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QyxnQkFBaUIsQ0FBQSxjQUFBLENBQS9CLEtBQWtEO0lBTGQ7OzZCQU90QyxXQUFBLEdBQWEsU0FBQTthQUNYLElBQUMsQ0FBQSxhQUFhLENBQUMsT0FBZixDQUFBO0lBRFc7OzZCQUdiLGdCQUFBLEdBQWtCLFNBQUMsR0FBRDthQUNoQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQVosQ0FBZ0IsR0FBaEIsRUFBcUI7UUFBQSxLQUFBLEVBQU8sSUFBQyxDQUFBLE1BQU0sQ0FBQyxzQkFBUixDQUFBLENBQVA7T0FBckI7SUFEZ0I7Ozs7O0FBbk1wQiIsInNvdXJjZXNDb250ZW50IjpbIl8gPSByZXF1aXJlICd1bmRlcnNjb3JlLXBsdXMnXG57Q29tcG9zaXRlRGlzcG9zYWJsZX0gPSByZXF1aXJlICdhdG9tJ1xuU2VsZWN0b3JDYWNoZSA9IHJlcXVpcmUgJy4vc2VsZWN0b3ItY2FjaGUnXG5cbm1vZHVsZS5leHBvcnRzID1cbmNsYXNzIEJyYWNrZXRNYXRjaGVyXG4gIGNvbnN0cnVjdG9yOiAoQGVkaXRvciwgZWRpdG9yRWxlbWVudCwgQG1hdGNoTWFuYWdlcikgLT5cbiAgICBAc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlXG4gICAgQGJyYWNrZXRNYXJrZXJzID0gW11cblxuICAgIF8uYWR2aXNlQmVmb3JlKEBlZGl0b3IsICdpbnNlcnRUZXh0JywgQGluc2VydFRleHQpXG4gICAgXy5hZHZpc2VCZWZvcmUoQGVkaXRvciwgJ2luc2VydE5ld2xpbmUnLCBAaW5zZXJ0TmV3bGluZSlcbiAgICBfLmFkdmlzZUJlZm9yZShAZWRpdG9yLCAnYmFja3NwYWNlJywgQGJhY2tzcGFjZSlcblxuICAgIEBzdWJzY3JpcHRpb25zLmFkZCBhdG9tLmNvbW1hbmRzLmFkZCBlZGl0b3JFbGVtZW50LCAnYnJhY2tldC1tYXRjaGVyOnJlbW92ZS1icmFja2V0cy1mcm9tLXNlbGVjdGlvbicsIChldmVudCkgPT5cbiAgICAgIGV2ZW50LmFib3J0S2V5QmluZGluZygpIHVubGVzcyBAcmVtb3ZlQnJhY2tldHMoKVxuXG4gICAgQHN1YnNjcmlwdGlvbnMuYWRkIEBlZGl0b3Iub25EaWREZXN0cm95ID0+IEB1bnN1YnNjcmliZSgpXG5cbiAgaW5zZXJ0VGV4dDogKHRleHQsIG9wdGlvbnMpID0+XG4gICAgcmV0dXJuIHRydWUgdW5sZXNzIHRleHRcbiAgICByZXR1cm4gdHJ1ZSBpZiBvcHRpb25zPy5zZWxlY3Qgb3Igb3B0aW9ucz8udW5kbyBpcyAnc2tpcCdcblxuICAgIHJldHVybiBmYWxzZSBpZiBAd3JhcFNlbGVjdGlvbkluQnJhY2tldHModGV4dClcbiAgICByZXR1cm4gdHJ1ZSBpZiBAZWRpdG9yLmhhc011bHRpcGxlQ3Vyc29ycygpXG5cbiAgICBjdXJzb3JCdWZmZXJQb3NpdGlvbiA9IEBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKVxuICAgIHByZXZpb3VzQ2hhcmFjdGVycyA9IEBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoW1tjdXJzb3JCdWZmZXJQb3NpdGlvbi5yb3csIDBdLCBjdXJzb3JCdWZmZXJQb3NpdGlvbl0pXG4gICAgbmV4dENoYXJhY3RlciA9IEBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoW2N1cnNvckJ1ZmZlclBvc2l0aW9uLCBjdXJzb3JCdWZmZXJQb3NpdGlvbi50cmF2ZXJzZShbMCwgMV0pXSlcblxuICAgIHByZXZpb3VzQ2hhcmFjdGVyID0gcHJldmlvdXNDaGFyYWN0ZXJzLnNsaWNlKC0xKVxuXG4gICAgaGFzV29yZEFmdGVyQ3Vyc29yID0gL1xcdy8udGVzdChuZXh0Q2hhcmFjdGVyKVxuICAgIGhhc1dvcmRCZWZvcmVDdXJzb3IgPSAvXFx3Ly50ZXN0KHByZXZpb3VzQ2hhcmFjdGVyKVxuICAgIGhhc1F1b3RlQmVmb3JlQ3Vyc29yID0gQGlzUXVvdGUocHJldmlvdXNDaGFyYWN0ZXIpIGFuZCBwcmV2aW91c0NoYXJhY3RlciBpcyB0ZXh0WzBdXG4gICAgIyBMb25lIGVzY2FwZSBjaGFyYWN0ZXIgLSBvZGQgbnVtYmVyIG9mIGJhY2tzbGFzaGVzIGJlZm9yZSBjdXJzb3JcbiAgICBoYXNFc2NhcGVDaGFyYWN0ZXJCZWZvcmVDdXJzb3IgPSBwcmV2aW91c0NoYXJhY3RlcnMubWF0Y2goLyhcXFxcKykkLyk/WzFdLmxlbmd0aCAlIDIgaXMgMVxuICAgICMgQ29tcGxldGVkIGVzY2FwZSBzZXF1ZW5jZSAtIGV2ZW4gbnVtYmVyIG9mIGJhY2tzbGFzaGVzIG9yIG9kZCBudW1iZXIgb2YgYmFja3NsYXNoZXMgZm9sbG93ZWQgYnkgYSBjaGFyYWN0ZXIgYmVmb3JlIGN1cnNvclxuICAgIGhhc0VzY2FwZVNlcXVlbmNlQmVmb3JlQ3Vyc29yID0gcHJldmlvdXNDaGFyYWN0ZXJzLm1hdGNoKC8oXFxcXCspW15cXFxcXSQvKT9bMV0ubGVuZ3RoICUgMiBpcyAxIG9yIHByZXZpb3VzQ2hhcmFjdGVycy5tYXRjaCgvKFxcXFwrKSQvKT9bMV0ubGVuZ3RoICUgMiBpcyAwXG5cbiAgICBpZiB0ZXh0IGlzICcjJyBhbmQgQGlzQ3Vyc29yT25JbnRlcnBvbGF0ZWRTdHJpbmcoKVxuICAgICAgYXV0b0NvbXBsZXRlT3BlbmluZ0JyYWNrZXQgPSBAZ2V0U2NvcGVkU2V0dGluZygnYnJhY2tldC1tYXRjaGVyLmF1dG9jb21wbGV0ZUJyYWNrZXRzJykgYW5kIG5vdCBoYXNFc2NhcGVDaGFyYWN0ZXJCZWZvcmVDdXJzb3JcbiAgICAgIHRleHQgKz0gJ3snXG4gICAgICBwYWlyID0gJ30nXG4gICAgZWxzZVxuICAgICAgYXV0b0NvbXBsZXRlT3BlbmluZ0JyYWNrZXQgPSBAZ2V0U2NvcGVkU2V0dGluZygnYnJhY2tldC1tYXRjaGVyLmF1dG9jb21wbGV0ZUJyYWNrZXRzJykgYW5kXG4gICAgICAgIEBpc09wZW5pbmdCcmFja2V0KHRleHQpIGFuZCBub3QgaGFzV29yZEFmdGVyQ3Vyc29yIGFuZCBub3RcbiAgICAgICAgKEBpc1F1b3RlKHRleHQpIGFuZCAoaGFzV29yZEJlZm9yZUN1cnNvciBvciBoYXNRdW90ZUJlZm9yZUN1cnNvciBvciBoYXNFc2NhcGVTZXF1ZW5jZUJlZm9yZUN1cnNvcikpIGFuZCBub3QgaGFzRXNjYXBlQ2hhcmFjdGVyQmVmb3JlQ3Vyc29yXG4gICAgICBwYWlyID0gQG1hdGNoTWFuYWdlci5wYWlyZWRDaGFyYWN0ZXJzW3RleHRdXG5cbiAgICBza2lwT3ZlckV4aXN0aW5nQ2xvc2luZ0JyYWNrZXQgPSBmYWxzZVxuICAgIGlmIEBpc0Nsb3NpbmdCcmFja2V0KHRleHQpIGFuZCBuZXh0Q2hhcmFjdGVyIGlzIHRleHQgYW5kIG5vdCBoYXNFc2NhcGVDaGFyYWN0ZXJCZWZvcmVDdXJzb3JcbiAgICAgIGlmIGJyYWNrZXRNYXJrZXIgPSBfLmZpbmQoQGJyYWNrZXRNYXJrZXJzLCAobWFya2VyKSAtPiBtYXJrZXIuaXNWYWxpZCgpIGFuZCBtYXJrZXIuZ2V0QnVmZmVyUmFuZ2UoKS5lbmQuaXNFcXVhbChjdXJzb3JCdWZmZXJQb3NpdGlvbikpXG4gICAgICAgIHNraXBPdmVyRXhpc3RpbmdDbG9zaW5nQnJhY2tldCA9IHRydWVcblxuICAgIGlmIHNraXBPdmVyRXhpc3RpbmdDbG9zaW5nQnJhY2tldFxuICAgICAgYnJhY2tldE1hcmtlci5kZXN0cm95KClcbiAgICAgIF8ucmVtb3ZlKEBicmFja2V0TWFya2VycywgYnJhY2tldE1hcmtlcilcbiAgICAgIEBlZGl0b3IubW92ZVJpZ2h0KClcbiAgICAgIGZhbHNlXG4gICAgZWxzZSBpZiBhdXRvQ29tcGxldGVPcGVuaW5nQnJhY2tldFxuICAgICAgQGVkaXRvci5pbnNlcnRUZXh0KHRleHQgKyBwYWlyKVxuICAgICAgQGVkaXRvci5tb3ZlTGVmdCgpXG4gICAgICByYW5nZSA9IFtjdXJzb3JCdWZmZXJQb3NpdGlvbiwgY3Vyc29yQnVmZmVyUG9zaXRpb24udHJhdmVyc2UoWzAsIHRleHQubGVuZ3RoXSldXG4gICAgICBAYnJhY2tldE1hcmtlcnMucHVzaCBAZWRpdG9yLm1hcmtCdWZmZXJSYW5nZShyYW5nZSlcbiAgICAgIGZhbHNlXG5cbiAgaW5zZXJ0TmV3bGluZTogPT5cbiAgICByZXR1cm4gaWYgQGVkaXRvci5oYXNNdWx0aXBsZUN1cnNvcnMoKVxuICAgIHJldHVybiB1bmxlc3MgQGVkaXRvci5nZXRMYXN0U2VsZWN0aW9uKCkuaXNFbXB0eSgpXG5cbiAgICBjdXJzb3JCdWZmZXJQb3NpdGlvbiA9IEBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKVxuICAgIHByZXZpb3VzQ2hhcmFjdGVycyA9IEBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoW1tjdXJzb3JCdWZmZXJQb3NpdGlvbi5yb3csIDBdLCBjdXJzb3JCdWZmZXJQb3NpdGlvbl0pXG4gICAgbmV4dENoYXJhY3RlciA9IEBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoW2N1cnNvckJ1ZmZlclBvc2l0aW9uLCBjdXJzb3JCdWZmZXJQb3NpdGlvbi50cmF2ZXJzZShbMCwgMV0pXSlcblxuICAgIHByZXZpb3VzQ2hhcmFjdGVyID0gcHJldmlvdXNDaGFyYWN0ZXJzLnNsaWNlKC0xKVxuXG4gICAgIyBMb25lIGVzY2FwZSBjaGFyYWN0ZXIgLSBvZGQgbnVtYmVyIG9mIGJhY2tzbGFzaGVzIGJlZm9yZSBjdXJzb3JcbiAgICBoYXNFc2NhcGVDaGFyYWN0ZXJCZWZvcmVDdXJzb3IgPSBwcmV2aW91c0NoYXJhY3RlcnMubWF0Y2goLyhcXFxcKykkLyk/WzFdLmxlbmd0aCAlIDIgaXMgMVxuXG4gICAgaWYgQG1hdGNoTWFuYWdlci5wYWlyc1dpdGhFeHRyYU5ld2xpbmVbcHJldmlvdXNDaGFyYWN0ZXJdIGlzIG5leHRDaGFyYWN0ZXIgYW5kIG5vdCBoYXNFc2NhcGVDaGFyYWN0ZXJCZWZvcmVDdXJzb3JcbiAgICAgIEBlZGl0b3IudHJhbnNhY3QgPT5cbiAgICAgICAgQGVkaXRvci5pbnNlcnRUZXh0IFwiXFxuXFxuXCJcbiAgICAgICAgQGVkaXRvci5tb3ZlVXAoKVxuICAgICAgICBpZiBAZ2V0U2NvcGVkU2V0dGluZygnZWRpdG9yLmF1dG9JbmRlbnQnKVxuICAgICAgICAgIGN1cnNvclJvdyA9IEBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3dcbiAgICAgICAgICBAZWRpdG9yLmF1dG9JbmRlbnRCdWZmZXJSb3dzKGN1cnNvclJvdywgY3Vyc29yUm93ICsgMSlcbiAgICAgIGZhbHNlXG5cbiAgYmFja3NwYWNlOiA9PlxuICAgIHJldHVybiBpZiBAZWRpdG9yLmhhc011bHRpcGxlQ3Vyc29ycygpXG4gICAgcmV0dXJuIHVubGVzcyBAZWRpdG9yLmdldExhc3RTZWxlY3Rpb24oKS5pc0VtcHR5KClcblxuICAgIGN1cnNvckJ1ZmZlclBvc2l0aW9uID0gQGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpXG4gICAgcHJldmlvdXNDaGFyYWN0ZXJzID0gQGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShbW2N1cnNvckJ1ZmZlclBvc2l0aW9uLnJvdywgMF0sIGN1cnNvckJ1ZmZlclBvc2l0aW9uXSlcbiAgICBuZXh0Q2hhcmFjdGVyID0gQGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShbY3Vyc29yQnVmZmVyUG9zaXRpb24sIGN1cnNvckJ1ZmZlclBvc2l0aW9uLnRyYXZlcnNlKFswLCAxXSldKVxuXG4gICAgcHJldmlvdXNDaGFyYWN0ZXIgPSBwcmV2aW91c0NoYXJhY3RlcnMuc2xpY2UoLTEpXG5cbiAgICAjIExvbmUgZXNjYXBlIGNoYXJhY3RlciAtIG9kZCBudW1iZXIgb2YgYmFja3NsYXNoZXMgYmVmb3JlIGN1cnNvclxuICAgIGhhc0VzY2FwZUNoYXJhY3RlckJlZm9yZUN1cnNvciA9IHByZXZpb3VzQ2hhcmFjdGVycy5tYXRjaCgvKFxcXFwrKSQvKT9bMV0ubGVuZ3RoICUgMiBpcyAxXG5cbiAgICBpZiAoQG1hdGNoTWFuYWdlci5wYWlyZWRDaGFyYWN0ZXJzW3ByZXZpb3VzQ2hhcmFjdGVyXSBpcyBuZXh0Q2hhcmFjdGVyKSBhbmQgbm90IGhhc0VzY2FwZUNoYXJhY3RlckJlZm9yZUN1cnNvciBhbmQgQGdldFNjb3BlZFNldHRpbmcoJ2JyYWNrZXQtbWF0Y2hlci5hdXRvY29tcGxldGVCcmFja2V0cycpXG4gICAgICBAZWRpdG9yLnRyYW5zYWN0ID0+XG4gICAgICAgIEBlZGl0b3IubW92ZUxlZnQoKVxuICAgICAgICBAZWRpdG9yLmRlbGV0ZSgpXG4gICAgICAgIEBlZGl0b3IuZGVsZXRlKClcbiAgICAgIGZhbHNlXG5cbiAgcmVtb3ZlQnJhY2tldHM6IC0+XG4gICAgYnJhY2tldHNSZW1vdmVkID0gZmFsc2VcbiAgICBAZWRpdG9yLm11dGF0ZVNlbGVjdGVkVGV4dCAoc2VsZWN0aW9uKSA9PlxuICAgICAgcmV0dXJuIHVubGVzcyBAc2VsZWN0aW9uSXNXcmFwcGVkQnlNYXRjaGluZ0JyYWNrZXRzKHNlbGVjdGlvbilcblxuICAgICAgcmFuZ2UgPSBzZWxlY3Rpb24uZ2V0QnVmZmVyUmFuZ2UoKVxuICAgICAgb3B0aW9ucyA9IHJldmVyc2VkOiBzZWxlY3Rpb24uaXNSZXZlcnNlZCgpXG4gICAgICBzZWxlY3Rpb25TdGFydCA9IHJhbmdlLnN0YXJ0XG4gICAgICBpZiByYW5nZS5zdGFydC5yb3cgaXMgcmFuZ2UuZW5kLnJvd1xuICAgICAgICBzZWxlY3Rpb25FbmQgPSByYW5nZS5lbmQudHJhdmVyc2UoWzAsIC0yXSlcbiAgICAgIGVsc2VcbiAgICAgICAgc2VsZWN0aW9uRW5kID0gcmFuZ2UuZW5kLnRyYXZlcnNlKFswLCAtMV0pXG5cbiAgICAgIHRleHQgPSBzZWxlY3Rpb24uZ2V0VGV4dCgpXG4gICAgICBzZWxlY3Rpb24uaW5zZXJ0VGV4dCh0ZXh0LnN1YnN0cmluZygxLCB0ZXh0Lmxlbmd0aCAtIDEpKVxuICAgICAgc2VsZWN0aW9uLnNldEJ1ZmZlclJhbmdlKFtzZWxlY3Rpb25TdGFydCwgc2VsZWN0aW9uRW5kXSwgb3B0aW9ucylcbiAgICAgIGJyYWNrZXRzUmVtb3ZlZCA9IHRydWVcbiAgICBicmFja2V0c1JlbW92ZWRcblxuICB3cmFwU2VsZWN0aW9uSW5CcmFja2V0czogKGJyYWNrZXQpIC0+XG4gICAgcmV0dXJuIGZhbHNlIHVubGVzcyBAZ2V0U2NvcGVkU2V0dGluZygnYnJhY2tldC1tYXRjaGVyLndyYXBTZWxlY3Rpb25zSW5CcmFja2V0cycpXG5cbiAgICBpZiBicmFja2V0IGlzICcjJ1xuICAgICAgcmV0dXJuIGZhbHNlIHVubGVzcyBAaXNDdXJzb3JPbkludGVycG9sYXRlZFN0cmluZygpXG4gICAgICBicmFja2V0ID0gJyN7J1xuICAgICAgcGFpciA9ICd9J1xuICAgIGVsc2VcbiAgICAgIHJldHVybiBmYWxzZSB1bmxlc3MgQGlzT3BlbmluZ0JyYWNrZXQoYnJhY2tldClcbiAgICAgIHBhaXIgPSBAbWF0Y2hNYW5hZ2VyLnBhaXJlZENoYXJhY3RlcnNbYnJhY2tldF1cblxuICAgIHNlbGVjdGlvbldyYXBwZWQgPSBmYWxzZVxuICAgIEBlZGl0b3IubXV0YXRlU2VsZWN0ZWRUZXh0IChzZWxlY3Rpb24pIC0+XG4gICAgICByZXR1cm4gaWYgc2VsZWN0aW9uLmlzRW1wdHkoKVxuXG4gICAgICAjIERvbid0IHdyYXAgaW4gI3t9IGlmIHRoZSBzZWxlY3Rpb24gc3BhbnMgbW9yZSB0aGFuIG9uZSBsaW5lXG4gICAgICByZXR1cm4gaWYgYnJhY2tldCBpcyAnI3snIGFuZCBub3Qgc2VsZWN0aW9uLmdldEJ1ZmZlclJhbmdlKCkuaXNTaW5nbGVMaW5lKClcblxuICAgICAgc2VsZWN0aW9uV3JhcHBlZCA9IHRydWVcbiAgICAgIHJhbmdlID0gc2VsZWN0aW9uLmdldEJ1ZmZlclJhbmdlKClcbiAgICAgIG9wdGlvbnMgPSByZXZlcnNlZDogc2VsZWN0aW9uLmlzUmV2ZXJzZWQoKVxuICAgICAgc2VsZWN0aW9uLmluc2VydFRleHQoXCIje2JyYWNrZXR9I3tzZWxlY3Rpb24uZ2V0VGV4dCgpfSN7cGFpcn1cIilcbiAgICAgIHNlbGVjdGlvblN0YXJ0ID0gcmFuZ2Uuc3RhcnQudHJhdmVyc2UoWzAsIGJyYWNrZXQubGVuZ3RoXSlcbiAgICAgIGlmIHJhbmdlLnN0YXJ0LnJvdyBpcyByYW5nZS5lbmQucm93XG4gICAgICAgIHNlbGVjdGlvbkVuZCA9IHJhbmdlLmVuZC50cmF2ZXJzZShbMCwgYnJhY2tldC5sZW5ndGhdKVxuICAgICAgZWxzZVxuICAgICAgICBzZWxlY3Rpb25FbmQgPSByYW5nZS5lbmRcbiAgICAgIHNlbGVjdGlvbi5zZXRCdWZmZXJSYW5nZShbc2VsZWN0aW9uU3RhcnQsIHNlbGVjdGlvbkVuZF0sIG9wdGlvbnMpXG5cbiAgICBzZWxlY3Rpb25XcmFwcGVkXG5cbiAgaXNRdW90ZTogKHN0cmluZykgLT5cbiAgICAvWydcImBdLy50ZXN0KHN0cmluZylcblxuICBpc0N1cnNvck9uSW50ZXJwb2xhdGVkU3RyaW5nOiAtPlxuICAgIHVubGVzcyBAaW50ZXJwb2xhdGVkU3RyaW5nU2VsZWN0b3I/XG4gICAgICBzZWdtZW50cyA9IFtcbiAgICAgICAgJyouKi4qLmludGVycG9sYXRlZC5ydWJ5J1xuICAgICAgICAnc3RyaW5nLmludGVycG9sYXRlZC5ydWJ5J1xuICAgICAgICAnc3RyaW5nLnJlZ2V4cC5pbnRlcnBvbGF0ZWQucnVieSdcbiAgICAgICAgJ3N0cmluZy5xdW90ZWQuZG91YmxlLmNvZmZlZSdcbiAgICAgICAgJ3N0cmluZy51bnF1b3RlZC5oZXJlZG9jLnJ1YnknXG4gICAgICAgICdzdHJpbmcucXVvdGVkLmRvdWJsZS5saXZlc2NyaXB0J1xuICAgICAgICAnc3RyaW5nLnF1b3RlZC5kb3VibGUuaGVyZWRvYy5saXZlc2NyaXB0J1xuICAgICAgICAnc3RyaW5nLnF1b3RlZC5kb3VibGUuZWxpeGlyJ1xuICAgICAgICAnc3RyaW5nLnF1b3RlZC5kb3VibGUuaGVyZWRvYy5lbGl4aXInXG4gICAgICAgICdjb21tZW50LmRvY3VtZW50YXRpb24uaGVyZWRvYy5lbGl4aXInXG4gICAgICBdXG4gICAgICBAaW50ZXJwb2xhdGVkU3RyaW5nU2VsZWN0b3IgPSBTZWxlY3RvckNhY2hlLmdldChzZWdtZW50cy5qb2luKCcgfCAnKSlcbiAgICBAaW50ZXJwb2xhdGVkU3RyaW5nU2VsZWN0b3IubWF0Y2hlcyhAZWRpdG9yLmdldExhc3RDdXJzb3IoKS5nZXRTY29wZURlc2NyaXB0b3IoKS5nZXRTY29wZXNBcnJheSgpKVxuXG4gIGlzT3BlbmluZ0JyYWNrZXQ6IChzdHJpbmcpIC0+XG4gICAgQG1hdGNoTWFuYWdlci5wYWlyZWRDaGFyYWN0ZXJzLmhhc093blByb3BlcnR5KHN0cmluZylcblxuICBpc0Nsb3NpbmdCcmFja2V0OiAoc3RyaW5nKSAtPlxuICAgIEBtYXRjaE1hbmFnZXIucGFpcmVkQ2hhcmFjdGVyc0ludmVyc2UuaGFzT3duUHJvcGVydHkoc3RyaW5nKVxuXG4gIHNlbGVjdGlvbklzV3JhcHBlZEJ5TWF0Y2hpbmdCcmFja2V0czogKHNlbGVjdGlvbikgLT5cbiAgICByZXR1cm4gZmFsc2UgaWYgc2VsZWN0aW9uLmlzRW1wdHkoKVxuICAgIHNlbGVjdGVkVGV4dCA9IHNlbGVjdGlvbi5nZXRUZXh0KClcbiAgICBmaXJzdENoYXJhY3RlciA9IHNlbGVjdGVkVGV4dFswXVxuICAgIGxhc3RDaGFyYWN0ZXIgPSBzZWxlY3RlZFRleHRbc2VsZWN0ZWRUZXh0Lmxlbmd0aCAtIDFdXG4gICAgQG1hdGNoTWFuYWdlci5wYWlyZWRDaGFyYWN0ZXJzW2ZpcnN0Q2hhcmFjdGVyXSBpcyBsYXN0Q2hhcmFjdGVyXG5cbiAgdW5zdWJzY3JpYmU6IC0+XG4gICAgQHN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpXG5cbiAgZ2V0U2NvcGVkU2V0dGluZzogKGtleSkgLT5cbiAgICBhdG9tLmNvbmZpZy5nZXQoa2V5LCBzY29wZTogQGVkaXRvci5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCkpXG4iXX0=
