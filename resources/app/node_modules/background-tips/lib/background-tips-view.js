(function() {
  var BackgroundTipsElement, CompositeDisposable, Template, Tips, _;

  _ = require('underscore-plus');

  CompositeDisposable = require('event-kit').CompositeDisposable;

  Tips = require('./tips');

  Template = "<ul class=\"centered background-message\">\n  <li class=\"message\"></li>\n</ul>";

  module.exports = BackgroundTipsElement = (function() {
    BackgroundTipsElement.prototype.StartDelay = 1000;

    BackgroundTipsElement.prototype.DisplayDuration = 10000;

    BackgroundTipsElement.prototype.FadeDuration = 300;

    function BackgroundTipsElement() {
      this.element = document.createElement('background-tips');
      this.index = -1;
      this.disposables = new CompositeDisposable;
      this.disposables.add(atom.workspace.onDidAddPane((function(_this) {
        return function() {
          return _this.updateVisibility();
        };
      })(this)));
      this.disposables.add(atom.workspace.onDidDestroyPane((function(_this) {
        return function() {
          return _this.updateVisibility();
        };
      })(this)));
      this.disposables.add(atom.workspace.onDidChangeActivePaneItem((function(_this) {
        return function() {
          return _this.updateVisibility();
        };
      })(this)));
      this.startTimeout = setTimeout(((function(_this) {
        return function() {
          return _this.start();
        };
      })(this)), this.StartDelay);
    }

    BackgroundTipsElement.prototype.destroy = function() {
      this.stop();
      this.disposables.dispose();
      return this.destroyed = true;
    };

    BackgroundTipsElement.prototype.attach = function() {
      var paneView, ref, ref1, top;
      this.element.innerHTML = Template;
      this.message = this.element.querySelector('.message');
      paneView = atom.views.getView(atom.workspace.getActivePane());
      top = (ref = (ref1 = paneView.querySelector('.item-views')) != null ? ref1.offsetTop : void 0) != null ? ref : 0;
      this.element.style.top = top + 'px';
      return paneView.appendChild(this.element);
    };

    BackgroundTipsElement.prototype.detach = function() {
      return this.element.remove();
    };

    BackgroundTipsElement.prototype.updateVisibility = function() {
      if (this.shouldBeAttached()) {
        return this.start();
      } else {
        return this.stop();
      }
    };

    BackgroundTipsElement.prototype.shouldBeAttached = function() {
      var base, ref;
      return ((ref = typeof (base = atom.workspace).getCenter === "function" ? base.getCenter() : void 0) != null ? ref : atom.workspace).getPanes().length === 1 && (atom.workspace.getActivePaneItem() == null);
    };

    BackgroundTipsElement.prototype.start = function() {
      if (!this.shouldBeAttached() || (this.interval != null)) {
        return;
      }
      this.renderTips();
      this.randomizeIndex();
      this.attach();
      this.showNextTip();
      return this.interval = setInterval(((function(_this) {
        return function() {
          return _this.showNextTip();
        };
      })(this)), this.DisplayDuration);
    };

    BackgroundTipsElement.prototype.stop = function() {
      this.element.remove();
      if (this.interval != null) {
        clearInterval(this.interval);
      }
      clearTimeout(this.startTimeout);
      clearTimeout(this.nextTipTimeout);
      return this.interval = null;
    };

    BackgroundTipsElement.prototype.randomizeIndex = function() {
      var len;
      len = Tips.length;
      return this.index = Math.round(Math.random() * len) % len;
    };

    BackgroundTipsElement.prototype.showNextTip = function() {
      this.index = ++this.index % Tips.length;
      this.message.classList.remove('fade-in');
      return this.nextTipTimeout = setTimeout((function(_this) {
        return function() {
          _this.message.innerHTML = Tips[_this.index];
          return _this.message.classList.add('fade-in');
        };
      })(this), this.FadeDuration);
    };

    BackgroundTipsElement.prototype.renderTips = function() {
      var i, j, len1, tip;
      if (this.tipsRendered) {
        return;
      }
      for (i = j = 0, len1 = Tips.length; j < len1; i = ++j) {
        tip = Tips[i];
        Tips[i] = this.renderTip(tip);
      }
      return this.tipsRendered = true;
    };

    BackgroundTipsElement.prototype.renderTip = function(str) {
      str = str.replace(/\{(.+)\}/g, (function(_this) {
        return function(match, command) {
          var binding, bindings, j, keystrokeLabel, len1, scope, scopeAndCommand;
          scopeAndCommand = command.split('>');
          if (scopeAndCommand.length > 1) {
            scope = scopeAndCommand[0], command = scopeAndCommand[1];
          }
          bindings = atom.keymaps.findKeyBindings({
            command: command.trim()
          });
          if (scope) {
            for (j = 0, len1 = bindings.length; j < len1; j++) {
              binding = bindings[j];
              if (binding.selector === scope) {
                break;
              }
            }
          } else {
            binding = _this.getKeyBindingForCurrentPlatform(bindings);
          }
          if (binding != null ? binding.keystrokes : void 0) {
            keystrokeLabel = _.humanizeKeystroke(binding.keystrokes).replace(/\s+/g, '&nbsp;');
            return "<span class=\"keystroke\">" + keystrokeLabel + "</span>";
          } else {
            return command;
          }
        };
      })(this));
      return str;
    };

    BackgroundTipsElement.prototype.getKeyBindingForCurrentPlatform = function(bindings) {
      var binding, j, len1;
      if (!(bindings != null ? bindings.length : void 0)) {
        return;
      }
      for (j = 0, len1 = bindings.length; j < len1; j++) {
        binding = bindings[j];
        if (binding.selector.indexOf(process.platform) !== -1) {
          return binding;
        }
      }
      return bindings[0];
    };

    return BackgroundTipsElement;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmlsZTovLy9DOi9wcm9qZWN0cy9hdG9tL291dC9hcHAvbm9kZV9tb2R1bGVzL2JhY2tncm91bmQtdGlwcy9saWIvYmFja2dyb3VuZC10aXBzLXZpZXcuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQTs7RUFBQSxDQUFBLEdBQUksT0FBQSxDQUFRLGlCQUFSOztFQUNILHNCQUF1QixPQUFBLENBQVEsV0FBUjs7RUFDeEIsSUFBQSxHQUFPLE9BQUEsQ0FBUSxRQUFSOztFQUVQLFFBQUEsR0FBVzs7RUFNWCxNQUFNLENBQUMsT0FBUCxHQUNNO29DQUNKLFVBQUEsR0FBWTs7b0NBQ1osZUFBQSxHQUFpQjs7b0NBQ2pCLFlBQUEsR0FBYzs7SUFFRCwrQkFBQTtNQUNYLElBQUMsQ0FBQSxPQUFELEdBQVcsUUFBUSxDQUFDLGFBQVQsQ0FBdUIsaUJBQXZCO01BQ1gsSUFBQyxDQUFBLEtBQUQsR0FBUyxDQUFDO01BRVYsSUFBQyxDQUFBLFdBQUQsR0FBZSxJQUFJO01BQ25CLElBQUMsQ0FBQSxXQUFXLENBQUMsR0FBYixDQUFpQixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQWYsQ0FBNEIsQ0FBQSxTQUFBLEtBQUE7ZUFBQSxTQUFBO2lCQUFHLEtBQUMsQ0FBQSxnQkFBRCxDQUFBO1FBQUg7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQTVCLENBQWpCO01BQ0EsSUFBQyxDQUFBLFdBQVcsQ0FBQyxHQUFiLENBQWlCLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWYsQ0FBZ0MsQ0FBQSxTQUFBLEtBQUE7ZUFBQSxTQUFBO2lCQUFHLEtBQUMsQ0FBQSxnQkFBRCxDQUFBO1FBQUg7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBQWhDLENBQWpCO01BQ0EsSUFBQyxDQUFBLFdBQVcsQ0FBQyxHQUFiLENBQWlCLElBQUksQ0FBQyxTQUFTLENBQUMseUJBQWYsQ0FBeUMsQ0FBQSxTQUFBLEtB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QUFBLEdBQVUsS0FBQyxDQUFBLCtCQUFELENBQWlDLFFBQWpDLEVBSlo7O1VBTUEsc0JBQUcsT0FBTyxDQUFFLG1CQUFaO1lBQ0UsY0FBQSxHQUFpQixDQUFDLENBQUMsaUJBQUYsQ0FBb0IsT0FBTyxDQUFDLFVBQTVCLENBQXVDLENBQUMsT0FBeEMsQ0FBZ0QsTUFBaEQsRUFBd0QsUUFBeEQ7bUJBQ2pCLDRCQUFBLEdBQTZCLGNBQTdCLEdBQTRDLFVBRjlDO1dBQUEsTUFBQTttQkFJRSxRQUpGOztRQVg2QjtNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBekI7YUFnQk47SUFqQlM7O29DQW1CWCwrQkFBQSxHQUFpQyxTQUFDLFFBQUQ7QUFDL0IsVUFBQTtNQUFBLElBQUEscUJBQWMsUUFBUSxDQUFFLGdCQUF4QjtBQUFBLGVBQUE7O0FBQ0EsV0FBQSw0Q0FBQTs7WUFBNEMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFqQixDQUF5QixPQUFPLENBQUMsUUFBakMsQ0FBQSxLQUFnRCxDQUFDO0FBQTdGLGlCQUFPOztBQUFQO0FBQ0EsYUFBTyxRQUFTLENBQUEsQ0FBQTtJQUhlOzs7OztBQTFHbkMiLCJzb3VyY2VzQ29udGVudCI6WyJfID0gcmVxdWlyZSAndW5kZXJzY29yZS1wbHVzJ1xue0NvbXBvc2l0ZURpc3Bvc2FibGV9ID0gcmVxdWlyZSAnZXZlbnQta2l0J1xuVGlwcyA9IHJlcXVpcmUgJy4vdGlwcydcblxuVGVtcGxhdGUgPSBcIlwiXCJcbiAgPHVsIGNsYXNzPVwiY2VudGVyZWQgYmFja2dyb3VuZC1tZXNzYWdlXCI+XG4gICAgPGxpIGNsYXNzPVwibWVzc2FnZVwiPjwvbGk+XG4gIDwvdWw+XG5cIlwiXCJcblxubW9kdWxlLmV4cG9ydHMgPVxuY2xhc3MgQmFja2dyb3VuZFRpcHNFbGVtZW50XG4gIFN0YXJ0RGVsYXk6IDEwMDBcbiAgRGlzcGxheUR1cmF0aW9uOiAxMDAwMFxuICBGYWRlRHVyYXRpb246IDMwMFxuXG4gIGNvbnN0cnVjdG9yOiAtPlxuICAgIEBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYmFja2dyb3VuZC10aXBzJylcbiAgICBAaW5kZXggPSAtMVxuXG4gICAgQGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgICBAZGlzcG9zYWJsZXMuYWRkIGF0b20ud29ya3NwYWNlLm9uRGlkQWRkUGFuZSA9PiBAdXBkYXRlVmlzaWJpbGl0eSgpXG4gICAgQGRpc3Bvc2FibGVzLmFkZCBhdG9tLndvcmtzcGFjZS5vbkRpZERlc3Ryb3lQYW5lID0+IEB1cGRhdGVWaXNpYmlsaXR5KClcbiAgICBAZGlzcG9zYWJsZXMuYWRkIGF0b20ud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0gPT4gQHVwZGF0ZVZpc2liaWxpdHkoKVxuXG4gICAgQHN0YXJ0VGltZW91dCA9IHNldFRpbWVvdXQoKD0+IEBzdGFydCgpKSwgQFN0YXJ0RGVsYXkpXG5cbiAgZGVzdHJveTogLT5cbiAgICBAc3RvcCgpXG4gICAgQGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIEBkZXN0cm95ZWQgPSB0cnVlXG5cbiAgYXR0YWNoOiAtPlxuICAgIEBlbGVtZW50LmlubmVySFRNTCA9IFRlbXBsYXRlXG4gICAgQG1lc3NhZ2UgPSBAZWxlbWVudC5xdWVyeVNlbGVjdG9yKCcubWVzc2FnZScpXG5cbiAgICBwYW5lVmlldyA9IGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVQYW5lKCkpXG4gICAgdG9wID0gcGFuZVZpZXcucXVlcnlTZWxlY3RvcignLml0ZW0tdmlld3MnKT8ub2Zmc2V0VG9wID8gMFxuICAgIEBlbGVtZW50LnN0eWxlLnRvcCA9IHRvcCArICdweCdcbiAgICBwYW5lVmlldy5hcHBlbmRDaGlsZChAZWxlbWVudClcblxuICBkZXRhY2g6IC0+XG4gICAgQGVsZW1lbnQucmVtb3ZlKClcblxuICB1cGRhdGVWaXNpYmlsaXR5OiAtPlxuICAgIGlmIEBzaG91bGRCZUF0dGFjaGVkKClcbiAgICAgIEBzdGFydCgpXG4gICAgZWxzZVxuICAgICAgQHN0b3AoKVxuXG4gIHNob3VsZEJlQXR0YWNoZWQ6IC0+XG4gICAgIyBUT0RPOiBSZW1vdmUgdGhpcyBhZnRlciBhdG9tL2F0b20jMTM5NzcgbGFuZHMgaW4gZmF2b3Igb2YgdW5ndWFyZGVkIGBnZXRDZW50ZXIoKWAgY2FsbFxuICAgIChhdG9tLndvcmtzcGFjZS5nZXRDZW50ZXI/KCkgPyBhdG9tLndvcmtzcGFjZSkuZ2V0UGFuZXMoKS5sZW5ndGggaXMgMSBhbmQgbm90IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCk/XG5cbiAgc3RhcnQ6IC0+XG4gICAgcmV0dXJuIGlmIG5vdCBAc2hvdWxkQmVBdHRhY2hlZCgpIG9yIEBpbnRlcnZhbD9cbiAgICBAcmVuZGVyVGlwcygpXG4gICAgQHJhbmRvbWl6ZUluZGV4KClcbiAgICBAYXR0YWNoKClcbiAgICBAc2hvd05leHRUaXAoKVxuICAgIEBpbnRlcnZhbCA9IHNldEludGVydmFsKCg9PiBAc2hvd05leHRUaXAoKSksIEBEaXNwbGF5RHVyYXRpb24pXG5cbiAgc3RvcDogLT5cbiAgICBAZWxlbWVudC5yZW1vdmUoKVxuICAgIGNsZWFySW50ZXJ2YWwoQGludGVydmFsKSBpZiBAaW50ZXJ2YWw/XG4gICAgY2xlYXJUaW1lb3V0KEBzdGFydFRpbWVvdXQpXG4gICAgY2xlYXJUaW1lb3V0KEBuZXh0VGlwVGltZW91dClcbiAgICBAaW50ZXJ2YWwgPSBudWxsXG5cbiAgcmFuZG9taXplSW5kZXg6IC0+XG4gICAgbGVuID0gVGlwcy5sZW5ndGhcbiAgICBAaW5kZXggPSBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiBsZW4pICUgbGVuXG5cbiAgc2hvd05leHRUaXA6IC0+XG4gICAgQGluZGV4ID0gKytAaW5kZXggJSBUaXBzLmxlbmd0aFxuICAgIEBtZXNzYWdlLmNsYXNzTGlzdC5yZW1vdmUoJ2ZhZGUtaW4nKVxuICAgIEBuZXh0VGlwVGltZW91dCA9IHNldFRpbWVvdXQgPT5cbiAgICAgIEBtZXNzYWdlLmlubmVySFRNTCA9IFRpcHNbQGluZGV4XVxuICAgICAgQG1lc3NhZ2UuY2xhc3NMaXN0LmFkZCgnZmFkZS1pbicpXG4gICAgLCBARmFkZUR1cmF0aW9uXG5cbiAgcmVuZGVyVGlwczogLT5cbiAgICByZXR1cm4gaWYgQHRpcHNSZW5kZXJlZFxuICAgIGZvciB0aXAsIGkgaW4gVGlwc1xuICAgICAgVGlwc1tpXSA9IEByZW5kZXJUaXAodGlwKVxuICAgIEB0aXBzUmVuZGVyZWQgPSB0cnVlXG5cbiAgcmVuZGVyVGlwOiAoc3RyKSAtPlxuICAgIHN0ciA9IHN0ci5yZXBsYWNlIC9cXHsoLispXFx9L2csIChtYXRjaCwgY29tbWFuZCkgPT5cbiAgICAgIHNjb3BlQW5kQ29tbWFuZCA9IGNvbW1hbmQuc3BsaXQoJz4nKVxuICAgICAgW3Njb3BlLCBjb21tYW5kXSA9IHNjb3BlQW5kQ29tbWFuZCBpZiBzY29wZUFuZENvbW1hbmQubGVuZ3RoID4gMVxuICAgICAgYmluZGluZ3MgPSBhdG9tLmtleW1hcHMuZmluZEtleUJpbmRpbmdzKGNvbW1hbmQ6IGNvbW1hbmQudHJpbSgpKVxuXG4gICAgICBpZiBzY29wZVxuICAgICAgICBmb3IgYmluZGluZyBpbiBiaW5kaW5nc1xuICAgICAgICAgIGJyZWFrIGlmIGJpbmRpbmcuc2VsZWN0b3IgaXMgc2NvcGVcbiAgICAgIGVsc2VcbiAgICAgICAgYmluZGluZyA9IEBnZXRLZXlCaW5kaW5nRm9yQ3VycmVudFBsYXRmb3JtKGJpbmRpbmdzKVxuXG4gICAgICBpZiBiaW5kaW5nPy5rZXlzdHJva2VzXG4gICAgICAgIGtleXN0cm9rZUxhYmVsID0gXy5odW1hbml6ZUtleXN0cm9rZShiaW5kaW5nLmtleXN0cm9rZXMpLnJlcGxhY2UoL1xccysvZywgJyZuYnNwOycpXG4gICAgICAgIFwiPHNwYW4gY2xhc3M9XFxcImtleXN0cm9rZVxcXCI+I3trZXlzdHJva2VMYWJlbH08L3NwYW4+XCJcbiAgICAgIGVsc2VcbiAgICAgICAgY29tbWFuZFxuICAgIHN0clxuXG4gIGdldEtleUJpbmRpbmdGb3JDdXJyZW50UGxhdGZvcm06IChiaW5kaW5ncykgLT5cbiAgICByZXR1cm4gdW5sZXNzIGJpbmRpbmdzPy5sZW5ndGhcbiAgICByZXR1cm4gYmluZGluZyBmb3IgYmluZGluZyBpbiBiaW5kaW5ncyB3aGVuIGJpbmRpbmcuc2VsZWN0b3IuaW5kZXhPZihwcm9jZXNzLnBsYXRmb3JtKSBpc250IC0xXG4gICAgcmV0dXJuIGJpbmRpbmdzWzBdXG4iXX0=
