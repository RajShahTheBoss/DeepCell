Object.defineProperty(exports, '__esModule', {
  value: true
});

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } }; })();

exports.activate = activate;
exports.deactivate = deactivate;
exports.consumeStatusBar = consumeStatusBar;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _underscorePlus = require('underscore-plus');

var _underscorePlus2 = _interopRequireDefault(_underscorePlus);

var _atom = require('atom');

var _atomSelectList = require('atom-select-list');

var _atomSelectList2 = _interopRequireDefault(_atomSelectList);

var _statusBarItem = require('./status-bar-item');

var _statusBarItem2 = _interopRequireDefault(_statusBarItem);

var _helpers = require('./helpers');

var _helpers2 = _interopRequireDefault(_helpers);

'use babel';

var LineEndingRegExp = /\r\n|\n/g;
var LFRegExp = /(^|[^\r])\n/g;
var CRLFRegExp = /\r\n/g;

var disposables = null;
var modalPanel = null;
var lineEndingListView = null;

function activate() {
  disposables = new _atom.CompositeDisposable();

  disposables.add(atom.commands.add('atom-text-editor', {
    'line-ending-selector:show': function lineEndingSelectorShow(event) {
      if (!modalPanel) {
        lineEndingListView = new _atomSelectList2['default']({
          items: [{ name: 'LF', value: '\n' }, { name: 'CRLF', value: '\r\n' }],
          filterKeyForItem: function filterKeyForItem(lineEnding) {
            return lineEnding.name;
          },
          didConfirmSelection: function didConfirmSelection(lineEnding) {
            // TODO[v1.19]: Remove conditional once atom.workspace.getActiveTextEditor ships in Atom v1.19
            if (atom.workspace.getActiveTextEditor) {
              setLineEnding(atom.workspace.getActiveTextEditor(), lineEnding.value);
            } else {
              setLineEnding(atom.workspace.getActivePaneItem(), lineEnding.value);
            }
            modalPanel.hide();
          },
          didCancelSelection: function didCancelSelection() {
            modalPanel.hide();
          },
          elementForItem: function elementForItem(lineEnding) {
            var element = document.createElement('li');
            element.textContent = lineEnding.name;
            return element;
          }
        });
        modalPanel = atom.workspace.addModalPanel({ item: lineEndingListView });
        disposables.add(new _atom.Disposable(function () {
          lineEndingListView.destroy();
          modalPanel.destroy();
          modalPanel = null;
        }));
      }

      lineEndingListView.reset();
      modalPanel.show();
      lineEndingListView.focus();
    },

    'line-ending-selector:convert-to-LF': function lineEndingSelectorConvertToLF(event) {
      var editorElement = event.target.closest('atom-text-editor');
      setLineEnding(editorElement.getModel(), '\n');
    },

    'line-ending-selector:convert-to-CRLF': function lineEndingSelectorConvertToCRLF(event) {
      var editorElement = event.target.closest('atom-text-editor');
      setLineEnding(editorElement.getModel(), '\r\n');
    }
  }));
}

function deactivate() {
  disposables.dispose();
}

function consumeStatusBar(statusBar) {
  var statusBarItem = new _statusBarItem2['default']();
  var currentBufferDisposable = null;
  var tooltipDisposable = null;

  var updateTile = _underscorePlus2['default'].debounce(function (buffer) {
    getLineEndings(buffer).then(function (lineEndings) {
      if (lineEndings.size === 0) {
        var defaultLineEnding = getDefaultLineEnding();
        buffer.setPreferredLineEnding(defaultLineEnding);
        lineEndings = new Set().add(defaultLineEnding);
      }
      statusBarItem.setLineEndings(lineEndings);
    });
  }, 0);

  var observeActiveItem = function observeActiveItem(item) {
    if (currentBufferDisposable) currentBufferDisposable.dispose();

    if (item && item.getBuffer) {
      (function () {
        var buffer = item.getBuffer();
        updateTile(buffer);
        currentBufferDisposable = buffer.onDidChange(function (_ref) {
          var oldText = _ref.oldText;
          var newText = _ref.newText;

          if (!statusBarItem.hasLineEnding('\n')) {
            if (newText.indexOf('\n') >= 0) {
              updateTile(buffer);
            }
          } else if (!statusBarItem.hasLineEnding('\r\n')) {
            if (newText.indexOf('\r\n') >= 0) {
              updateTile(buffer);
            }
          } else if (oldText.indexOf('\n')) {
            updateTile(buffer);
          }
        });
      })();
    } else {
      statusBarItem.setLineEndings(new Set());
      currentBufferDisposable = null;
    }

    if (tooltipDisposable) {
      disposables.remove(tooltipDisposable);
      tooltipDisposable.dispose();
    }
    tooltipDisposable = atom.tooltips.add(statusBarItem.element, { title: 'File uses ' + statusBarItem.description() + ' line endings' });
    disposables.add(tooltipDisposable);
  };

  // TODO[v1.19]: Remove conditional once atom.workspace.observeActiveTextEditor ships in Atom v1.19
  if (atom.workspace.observeActiveTextEditor) {
    disposables.add(atom.workspace.observeActiveTextEditor(observeActiveItem));
  } else {
    disposables.add(atom.workspace.observeActivePaneItem(observeActiveItem));
  }

  disposables.add(new _atom.Disposable(function () {
    if (currentBufferDisposable) currentBufferDisposable.dispose();
  }));

  statusBarItem.onClick(function () {
    var editor = undefined;

    // TODO[v1.19]: Remove conditional once atom.workspace.getActiveTextEditor ships in Atom v1.19
    if (atom.workspace.getActiveTextEditor) {
      editor = atom.workspace.getActiveTextEditor();
    } else {
      editor = atom.workspace.getActivePaneItem();
    }

    atom.commands.dispatch(atom.views.getView(editor), 'line-ending-selector:show');
  });

  var tile = statusBar.addRightTile({ item: statusBarItem, priority: 200 });
  disposables.add(new _atom.Disposable(function () {
    return tile.destroy();
  }));
}

function getDefaultLineEnding() {
  switch (atom.config.get('line-ending-selector.defaultLineEnding')) {
    case 'LF':
      return '\n';
    case 'CRLF':
      return '\r\n';
    case 'OS Default':
    default:
      return _helpers2['default'].getProcessPlatform() === 'win32' ? '\r\n' : '\n';
  }
}

function getLineEndings(buffer) {
  if (typeof buffer.search === 'function') {
    return Promise.all([buffer.search(LFRegExp), buffer.search(CRLFRegExp)]).then(function (_ref2) {
      var _ref22 = _slicedToArray(_ref2, 2);

      var hasLF = _ref22[0];
      var hasCRLF = _ref22[1];

      var result = new Set();
      if (hasLF) result.add('\n');
      if (hasCRLF) result.add('\r\n');
      return result;
    });
  } else {
    return new Promise(function (resolve) {
      var result = new Set();
      for (var i = 0; i < buffer.getLineCount() - 1; i++) {
        result.add(buffer.lineEndingForRow(i));
      }
      resolve(result);
    });
  }
}

function setLineEnding(item, lineEnding) {
  if (item && item.getBuffer) {
    var buffer = item.getBuffer();
    buffer.setPreferredLineEnding(lineEnding);
    buffer.setText(buffer.getText().replace(LineEndingRegExp, lineEnding));
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vQzovcHJvamVjdHMvYXRvbS9vdXQvYXBwL25vZGVfbW9kdWxlcy9saW5lLWVuZGluZy1zZWxlY3Rvci9saWIvbWFpbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OEJBRWMsaUJBQWlCOzs7O29CQUNlLE1BQU07OzhCQUN6QixrQkFBa0I7Ozs7NkJBQ25CLG1CQUFtQjs7Ozt1QkFDekIsV0FBVzs7OztBQU4vQixXQUFXLENBQUE7O0FBUVgsSUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUE7QUFDbkMsSUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFBO0FBQy9CLElBQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQTs7QUFFMUIsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFBO0FBQ3RCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQTtBQUNyQixJQUFJLGtCQUFrQixHQUFHLElBQUksQ0FBQTs7QUFFdEIsU0FBUyxRQUFRLEdBQUk7QUFDMUIsYUFBVyxHQUFHLCtCQUF5QixDQUFBOztBQUV2QyxhQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFO0FBQ3BELCtCQUEyQixFQUFFLGdDQUFDLEtBQUssRUFBSztBQUN0QyxVQUFJLENBQUMsVUFBVSxFQUFFO0FBQ2YsMEJBQWtCLEdBQUcsZ0NBQW1CO0FBQ3RDLGVBQUssRUFBRSxDQUFDLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFDLEVBQUUsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUMsQ0FBQztBQUNqRSwwQkFBZ0IsRUFBRSwwQkFBQyxVQUFVO21CQUFLLFVBQVUsQ0FBQyxJQUFJO1dBQUE7QUFDakQsNkJBQW1CLEVBQUUsNkJBQUMsVUFBVSxFQUFLOztBQUVuQyxnQkFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFO0FBQ3RDLDJCQUFhLENBQUMs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QyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNsRCxjQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO09BQ3ZDO0FBQ0QsYUFBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0tBQ2hCLENBQUMsQ0FBQTtHQUNIO0NBQ0Y7O0FBRUQsU0FBUyxhQUFhLENBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRTtBQUN4QyxNQUFJLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO0FBQzFCLFFBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtBQUM3QixVQUFNLENBQUMsc0JBQXNCLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDekMsVUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUE7R0FDdkU7Q0FDRiIsImZpbGUiOiJmaWxlOi8vL0M6L3Byb2plY3RzL2F0b20vb3V0L2FwcC9ub2RlX21vZHVsZXMvbGluZS1lbmRpbmctc2VsZWN0b3IvbGliL21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJ1xuXG5pbXBvcnQgXyBmcm9tICd1bmRlcnNjb3JlLXBsdXMnXG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGV9IGZyb20gJ2F0b20nXG5pbXBvcnQgU2VsZWN0TGlzdFZpZXcgZnJvbSAnYXRvbS1zZWxlY3QtbGlzdCdcbmltcG9ydCBTdGF0dXNCYXJJdGVtIGZyb20gJy4vc3RhdHVzLWJhci1pdGVtJ1xuaW1wb3J0IGhlbHBlcnMgZnJvbSAnLi9oZWxwZXJzJ1xuXG5jb25zdCBMaW5lRW5kaW5nUmVnRXhwID0gL1xcclxcbnxcXG4vZ1xuY29uc3QgTEZSZWdFeHAgPSAvKF58W15cXHJdKVxcbi9nXG5jb25zdCBDUkxGUmVnRXhwID0gL1xcclxcbi9nXG5cbmxldCBkaXNwb3NhYmxlcyA9IG51bGxcbmxldCBtb2RhbFBhbmVsID0gbnVsbFxubGV0IGxpbmVFbmRpbmdMaXN0VmlldyA9IG51bGxcblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlICgpIHtcbiAgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgZGlzcG9zYWJsZXMuYWRkKGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yJywge1xuICAgICdsaW5lLWVuZGluZy1zZWxlY3RvcjpzaG93JzogKGV2ZW50KSA9PiB7XG4gICAgICBpZiAoIW1vZGFsUGFuZWwpIHtcbiAgICAgICAgbGluZUVuZGluZ0xpc3RWaWV3ID0gbmV3IFNlbGVjdExpc3RWaWV3KHtcbiAgICAgICAgICBpdGVtczogW3tuYW1lOiAnTEYnLCB2YWx1ZTogJ1xcbid9LCB7bmFtZTogJ0NSTEYnLCB2YWx1ZTogJ1xcclxcbid9XSxcbiAgICAgICAgICBmaWx0ZXJLZXlGb3JJdGVtOiAobGluZUVuZGluZykgPT4gbGluZUVuZGluZy5uYW1lLFxuICAgICAgICAgIGRpZENvbmZpcm1TZWxlY3Rpb246IChsaW5lRW5kaW5nKSA9PiB7XG4gICAgICAgICAgICAvLyBUT0RPW3YxLjE5XTogUmVtb3ZlIGNvbmRpdGlvbmFsIG9uY2UgYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvciBzaGlwcyBpbiBBdG9tIHYxLjE5XG4gICAgICAgICAgICBpZiAoYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcikge1xuICAgICAgICAgICAgICBzZXRMaW5lRW5kaW5nKGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKSwgbGluZUVuZGluZy52YWx1ZSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNldExpbmVFbmRpbmcoYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZUl0ZW0oKSwgbGluZUVuZGluZy52YWx1ZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsUGFuZWwuaGlkZSgpXG4gICAgICAgICAgfSxcbiAgICAgICAgICBkaWRDYW5jZWxTZWxlY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgIG1vZGFsUGFuZWwuaGlkZSgpXG4gICAgICAgICAgfSxcbiAgICAgICAgICBlbGVtZW50Rm9ySXRlbTogKGxpbmVFbmRpbmcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpXG4gICAgICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gbGluZUVuZGluZy5uYW1lXG4gICAgICAgICAgICByZXR1cm4gZWxlbWVudFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgbW9kYWxQYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZE1vZGFsUGFuZWwoe2l0ZW06IGxpbmVFbmRpbmdMaXN0Vmlld30pXG4gICAgICAgIGRpc3Bvc2FibGVzLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgICAgbGluZUVuZGluZ0xpc3RWaWV3LmRlc3Ryb3koKVxuICAgICAgICAgIG1vZGFsUGFuZWwuZGVzdHJveSgpXG4gICAgICAgICAgbW9kYWxQYW5lbCA9IG51bGxcbiAgICAgICAgfSkpXG4gICAgICB9XG5cbiAgICAgIGxpbmVFbmRpbmdMaXN0Vmlldy5yZXNldCgpXG4gICAgICBtb2RhbFBhbmVsLnNob3coKVxuICAgICAgbGluZUVuZGluZ0xpc3RWaWV3LmZvY3VzKClcbiAgICB9LFxuXG4gICAgJ2xpbmUtZW5kaW5nLXNlbGVjdG9yOmNvbnZlcnQtdG8tTEYnOiAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IGVkaXRvckVsZW1lbnQgPSBldmVudC50YXJnZXQuY2xvc2VzdCgnYXRvbS10ZXh0LWVkaXRvcicpXG4gICAgICBzZXRMaW5lRW5kaW5nKGVkaXRvckVsZW1lbnQuZ2V0TW9kZWwoKSwgJ1xcbicpXG4gICAgfSxcblxuICAgICdsaW5lLWVuZGluZy1zZWxlY3Rvcjpjb252ZXJ0LXRvLUNSTEYnOiAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IGVkaXRvckVsZW1lbnQgPSBldmVudC50YXJnZXQuY2xvc2VzdCgnYXRvbS10ZXh0LWVkaXRvcicpXG4gICAgICBzZXRMaW5lRW5kaW5nKGVkaXRvckVsZW1lbnQuZ2V0TW9kZWwoKSwgJ1xcclxcbicpXG4gICAgfVxuICB9KSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUgKCkge1xuICBkaXNwb3NhYmxlcy5kaXNwb3NlKClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVTdGF0dXNCYXIgKHN0YXR1c0Jhcikge1xuICBsZXQgc3RhdHVzQmFySXRlbSA9IG5ldyBTdGF0dXNCYXJJdGVtKClcbiAgbGV0IGN1cnJlbnRCdWZmZXJEaXNwb3NhYmxlID0gbnVsbFxuICBsZXQgdG9vbHRpcERpc3Bvc2FibGUgPSBudWxsXG5cbiAgY29uc3QgdXBkYXRlVGlsZSA9IF8uZGVib3VuY2UoKGJ1ZmZlcikgPT4ge1xuICAgIGdldExpbmVFbmRpbmdzKGJ1ZmZlcikudGhlbigobGluZUVuZGluZ3MpID0+IHtcbiAgICAgIGlmIChsaW5lRW5kaW5ncy5zaXplID09PSAwKSB7XG4gICAgICAgIGxldCBkZWZhdWx0TGluZUVuZGluZyA9IGdldERlZmF1bHRMaW5lRW5kaW5nKClcbiAgICAgICAgYnVmZmVyLnNldFByZWZlcnJlZExpbmVFbmRpbmcoZGVmYXVsdExpbmVFbmRpbmcpXG4gICAgICAgIGxpbmVFbmRpbmdzID0gbmV3IFNldCgpLmFkZChkZWZhdWx0TGluZUVuZGluZylcbiAgICAgIH1cbiAgICAgIHN0YXR1c0Jhckl0ZW0uc2V0TGluZUVuZGluZ3MobGluZUVuZGluZ3MpXG4gICAgfSlcbiAgfSwgMClcblxuICBjb25zdCBvYnNlcnZlQWN0aXZlSXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgaWYgKGN1cnJlbnRCdWZmZXJEaXNwb3NhYmxlKSBjdXJyZW50QnVmZmVyRGlzcG9zYWJsZS5kaXNwb3NlKClcblxuICAgIGlmIChpdGVtICYmIGl0ZW0uZ2V0QnVmZmVyKSB7XG4gICAgICBsZXQgYnVmZmVyID0gaXRlbS5nZXRCdWZmZXIoKVxuICAgICAgdXBkYXRlVGlsZShidWZmZXIpXG4gICAgICBjdXJyZW50QnVmZmVyRGlzcG9zYWJsZSA9IGJ1ZmZlci5vbkRpZENoYW5nZSgoe29sZFRleHQsIG5ld1RleHR9KSA9PiB7XG4gICAgICAgIGlmICghc3RhdHVzQmFySXRlbS5oYXNMaW5lRW5kaW5nKCdcXG4nKSkge1xuICAgICAgICAgIGlmIChuZXdUZXh0LmluZGV4T2YoJ1xcbicpID49IDApIHtcbiAgICAgICAgICAgIHVwZGF0ZVRpbGUoYnVmZmVyKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICghc3RhdHVzQmFySXRlbS5oYXNMaW5lRW5kaW5nKCdcXHJcXG4nKSkge1xuICAgICAgICAgIGlmIChuZXdUZXh0LmluZGV4T2YoJ1xcclxcbicpID49IDApIHtcbiAgICAgICAgICAgIHVwZGF0ZVRpbGUoYnVmZmVyKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChvbGRUZXh0LmluZGV4T2YoJ1xcbicpKSB7XG4gICAgICAgICAgdXBkYXRlVGlsZShidWZmZXIpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXR1c0Jhckl0ZW0uc2V0TGluZUVuZGluZ3MobmV3IFNldCgpKVxuICAgICAgY3VycmVudEJ1ZmZlckRpc3Bvc2FibGUgPSBudWxsXG4gICAgfVxuXG4gICAgaWYgKHRvb2x0aXBEaXNwb3NhYmxlKSB7XG4gICAgICBkaXNwb3NhYmxlcy5yZW1vdmUodG9vbHRpcERpc3Bvc2FibGUpXG4gICAgICB0b29sdGlwRGlzcG9zYWJsZS5kaXNwb3NlKClcbiAgICB9XG4gICAgdG9vbHRpcERpc3Bvc2FibGUgPSBhdG9tLnRvb2x0aXBzLmFkZChzdGF0dXNCYXJJdGVtLmVsZW1lbnQsXG4gICAgICB7dGl0bGU6IGBGaWxlIHVzZXMgJHtzdGF0dXNCYXJJdGVtLmRlc2NyaXB0aW9uKCl9IGxpbmUgZW5kaW5nc2B9KVxuICAgIGRpc3Bvc2FibGVzLmFkZCh0b29sdGlwRGlzcG9zYWJsZSlcbiAgfVxuXG4gIC8vIFRPRE9bdjEuMTldOiBSZW1vdmUgY29uZGl0aW9uYWwgb25jZSBhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlVGV4dEVkaXRvciBzaGlwcyBpbiBBdG9tIHYxLjE5XG4gIGlmIChhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlVGV4dEVkaXRvcikge1xuICAgIGRpc3Bvc2FibGVzLmFkZChhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlVGV4dEVkaXRvcihvYnNlcnZlQWN0aXZlSXRlbSkpXG4gIH0gZWxzZSB7XG4gICAgZGlzcG9zYWJsZXMuYWRkKGF0b20ud29ya3NwYWNlLm9ic2VydmVBY3RpdmVQYW5lSXRlbShvYnNlcnZlQWN0aXZlSXRlbSkpXG4gIH1cblxuICBkaXNwb3NhYmxlcy5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgIGlmIChjdXJyZW50QnVmZmVyRGlzcG9zYWJsZSkgY3VycmVudEJ1ZmZlckRpc3Bvc2FibGUuZGlzcG9zZSgpXG4gIH0pKVxuXG4gIHN0YXR1c0Jhckl0ZW0ub25DbGljaygoKSA9PiB7XG4gICAgbGV0IGVkaXRvclxuXG4gICAgLy8gVE9ET1t2MS4xOV06IFJlbW92ZSBjb25kaXRpb25hbCBvbmNlIGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3Igc2hpcHMgaW4gQXRvbSB2MS4xOVxuICAgIGlmIChhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKSB7XG4gICAgICBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICB9IGVsc2Uge1xuICAgICAgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlUGFuZUl0ZW0oKVxuICAgIH1cblxuICAgIGF0b20uY29tbWFuZHMuZGlzcGF0Y2goXG4gICAgICBhdG9tLnZpZXdzLmdldFZpZXcoZWRpdG9yKSxcbiAgICAgICdsaW5lLWVuZGluZy1zZWxlY3RvcjpzaG93J1xuICAgIClcbiAgfSlcblxuICBsZXQgdGlsZSA9IHN0YXR1c0Jhci5hZGRSaWdodFRpbGUoe2l0ZW06IHN0YXR1c0Jhckl0ZW0sIHByaW9yaXR5OiAyMDB9KVxuICBkaXNwb3NhYmxlcy5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4gdGlsZS5kZXN0cm95KCkpKVxufVxuXG5mdW5jdGlvbiBnZXREZWZhdWx0TGluZUVuZGluZyAoKSB7XG4gIHN3aXRjaCAoYXRvbS5jb25maWcuZ2V0KCdsaW5lLWVuZGluZy1zZWxlY3Rvci5kZWZhdWx0TGluZUVuZGluZycpKSB7XG4gICAgY2FzZSAnTEYnOlxuICAgICAgcmV0dXJuICdcXG4nXG4gICAgY2FzZSAnQ1JMRic6XG4gICAgICByZXR1cm4gJ1xcclxcbidcbiAgICBjYXNlICdPUyBEZWZhdWx0JzpcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIChoZWxwZXJzLmdldFByb2Nlc3NQbGF0Zm9ybSgpID09PSAnd2luMzInKSA/ICdcXHJcXG4nIDogJ1xcbidcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRMaW5lRW5kaW5ncyAoYnVmZmVyKSB7XG4gIGlmICh0eXBlb2YgYnVmZmVyLnNlYXJjaCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICBidWZmZXIuc2VhcmNoKExGUmVnRXhwKSxcbiAgICAgIGJ1ZmZlci5zZWFyY2goQ1JMRlJlZ0V4cClcbiAgICBdKS50aGVuKChbaGFzTEYsIGhhc0NSTEZdKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBuZXcgU2V0KClcbiAgICAgIGlmIChoYXNMRikgcmVzdWx0LmFkZCgnXFxuJylcbiAgICAgIGlmIChoYXNDUkxGKSByZXN1bHQuYWRkKCdcXHJcXG4nKVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0pXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBuZXcgU2V0KClcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyLmdldExpbmVDb3VudCgpIC0gMTsgaSsrKSB7XG4gICAgICAgIHJlc3VsdC5hZGQoYnVmZmVyLmxpbmVFbmRpbmdGb3JSb3coaSkpXG4gICAgICB9XG4gICAgICByZXNvbHZlKHJlc3VsdClcbiAgICB9KVxuICB9XG59XG5cbmZ1bmN0aW9uIHNldExpbmVFbmRpbmcgKGl0ZW0sIGxpbmVFbmRpbmcpIHtcbiAgaWYgKGl0ZW0gJiYgaXRlbS5nZXRCdWZmZXIpIHtcbiAgICBsZXQgYnVmZmVyID0gaXRlbS5nZXRCdWZmZXIoKVxuICAgIGJ1ZmZlci5zZXRQcmVmZXJyZWRMaW5lRW5kaW5nKGxpbmVFbmRpbmcpXG4gICAgYnVmZmVyLnNldFRleHQoYnVmZmVyLmdldFRleHQoKS5yZXBsYWNlKExpbmVFbmRpbmdSZWdFeHAsIGxpbmVFbmRpbmcpKVxuICB9XG59XG4iXX0=