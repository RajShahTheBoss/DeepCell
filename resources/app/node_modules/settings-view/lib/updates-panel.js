Object.defineProperty(exports, '__esModule', {
  value: true
});

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

/** @babel */
/** @jsx etch.dom */

var _atom = require('atom');

var _etch = require('etch');

var _etch2 = _interopRequireDefault(_etch);

var _errorView = require('./error-view');

var _errorView2 = _interopRequireDefault(_errorView);

var _packageCard = require('./package-card');

var _packageCard2 = _interopRequireDefault(_packageCard);

var UpdatesPanel = (function () {
  function UpdatesPanel(settingsView, packageManager) {
    var _this = this;

    _classCallCheck(this, UpdatesPanel);

    this.settingsView = settingsView;
    this.packageManager = packageManager;
    this.disposables = new _atom.CompositeDisposable();
    this.updatingPackages = [];
    this.packageCards = [];

    _etch2['default'].initialize(this);

    this.refs.updateAllButton.style.display = 'none';
    this.checkForUpdates();

    this.disposables.add(atom.commands.add(this.element, {
      'core:move-up': function coreMoveUp() {
        _this.scrollUp();
      },
      'core:move-down': function coreMoveDown() {
        _this.scrollDown();
      },
      'core:page-up': function corePageUp() {
        _this.pageUp();
      },
      'core:page-down': function corePageDown() {
        _this.pageDown();
      },
      'core:move-to-top': function coreMoveToTop() {
        _this.scrollToTop();
      },
      'core:move-to-bottom': function coreMoveToBottom() {
        _this.scrollToBottom();
      }
    }));

    this.disposables.add(this.packageManager.on('package-updating theme-updating', function (_ref) {
      var pack = _ref.pack;
      var error = _ref.error;

      _this.refs.checkButton.disabled = true;
      _this.updatingPackages.push(pack);
    }));

    this.disposables.add(this.packageManager.on('package-updated theme-updated package-update-failed theme-update-failed', function (_ref2) {
      var pack = _ref2.pack;
      var error = _ref2.error;

      if (error != null) {
        _this.refs.updateErrors.appendChild(new _errorView2['default'](_this.packageManager, error).element);
      }

      for (var i = 0; i < _this.updatingPackages.length; i++) {
        var update = _this.updatingPackages[i];
        if (update.name === pack.name) {
          _this.updatingPackages.splice(i, 1);
        }
      }

      if (!_this.updatingPackages.length) {
        _this.refs.checkButton.disabled = false;
      }
    }));
  }

  _createClass(UpdatesPanel, [{
    key: 'destroy',
    value: function destroy() {
      this.clearPackageCards();
      this.disposables.dispose();
      return _etch2['default'].destroy(this);
    }
  }, {
    key: 'update',
    value: function update() {}
  }, {
    key: 'render',
    value: function render() {
      var _this2 = this;

      return _etch2['default'].dom(
        'div',
        { tabIndex: '0', className: 'panels-item' },
        _etch2['default'].dom(
          'section',
          { className: 'section packages' },
          _etch2['default'].dom(
            'div',
            { className: 'section-container updates-container' },
            _etch2['default'].dom(
              'div',
              { className: 'updates-heading-container' },
              _etch2['default'].dom(
                'h1',
                { className: 'section-heading icon icon-cloud-download' },
                'Available Updates'
              ),
              _etch2['default'].dom(
                'div',
                { className: 'section-heading updates-btn-group' },
                _etch2['default'].dom(
                  'button',
                  {
                    ref: 'updateAllButton',
                    className: 'pull-right update-all-button btn btn-primary',
                    onclick: function () {
                      _this2.updateAll();
                    } },
                  'Update All'
                ),
                _etch2['default'].dom(
                  'button',
                  {
                    ref: 'checkButton',
                    className: 'pull-right update-all-button btn btn',
                    onclick: function () {
                      _this2.checkForUpdates(true);
                    } },
                  'Check for Updates'
                )
              )
            ),
            _etch2['default'].dom('div', { ref: 'updateErrors' }),
            _etch2['default'].dom(
              'div',
              { ref: 'checkingMessage', className: 'alert alert-info icon icon-hourglass' },
              'Checking for updatesâ€¦'
            ),
            _etch2['default'].dom(
              'div',
              { ref: 'noUpdatesMessage', className: 'alert alert-info icon icon-heart' },
              'All of your installed packages are up to date!'
            ),
            _etch2['default'].dom('div', { ref: 'updatesContainer', className: 'container package-container' })
          )
        )
      );
    }
  }, {
    key: 'focus',
    value: function focus() {
      this.element.focus();
    }
  }, {
    key: 'show',
    value: function show() {
      this.element.style.display = '';
    }
  }, {
    key: 'beforeShow',
    value: function beforeShow(opts) {
      var _this3 = this;

      if (opts && opts.back) {
        this.refs.breadcrumb.textContent = opts.back;
        this.refs.breadcrumb.onclick = function () {
          _this3.settingsView.showPanel(opts.back);
        };
      }

      if (opts && opts.updates) {
        this.availableUpdates = opts.updates;
        this.addUpdateViews();
      } else {
        this.availableUpdates = [];
        this.clearPackageCards();
        this.checkForUpdates();
      }
    }

    // Check for updates and display them
  }, {
    key: 'checkForUpdates',
    value: _asyncToGenerator(function* (clearCache) {
      this.refs.noUpdatesMessage.style.display = 'none';
      this.refs.updateAllButton.disabled = true;
      this.refs.checkButton.disabled = true;
      this.refs.checkingMessage.style.display = '';

      try {
        this.availableUpdates = yield this.packageManager.getOutdated(clearCache);
        this.refs.checkButton.disabled = false;
        this.addUpdateViews();
      } catch (error) {
        this.refs.checkButton.disabled = false;
        this.refs.checkingMessage.style.display = 'none';
        this.refs.updateErrors.appendChild(new _errorView2['default'](this.packageManager, error).element);
      }
    })
  }, {
    key: 'addUpdateViews',
    value: function addUpdateViews() {
      if (this.availableUpdates.length > 0) {
        this.refs.updateAllButton.style.display = '';
        this.refs.updateAllButton.disabled = false;
      }
      this.refs.checkingMessage.style.display = 'none';
      this.clearPackageCards();
      if (this.availableUpdates.length === 0) {
        this.refs.noUpdatesMessage.style.display = '';
      }

      for (var pack of this.availableUpdates) {
        var packageCard = new _packageCard2['default'](pack, this.settingsView, this.packageManager, { back: 'Updates' });
        this.refs.updatesContainer.appendChild(packageCard.element);
        this.packageCards.push(packageCard);
      }
    }
  }, {
    key: 'updateAll',
    value: function updateAll() {
      var _this4 = this;

      this.refs.checkButton.disabled = true;
      this.refs.updateAllButton.disabled = true;

      var successfulUpdatesCount = 0;
      var remainingPackagesCount = this.packageCards.length;
      var totalUpdatesCount = this.packageCards.length; // This value doesn't change unlike remainingPackagesCount

      var notifyIfDone = function notifyIfDone() {
        if (remainingPackagesCount === 0) {
          if (successfulUpdatesCount > 0) {
            var pluralizedPackages = 'package';
            if (successfulUpdatesCount > 1) {
              pluralizedPackages += 's';
            }
            var message = 'Restart Atom to complete the update of ' + successfulUpdatesCount + ' ' + pluralizedPackages + '.';

            var buttons = [{
              text: 'Restart',
              onDidClick: function onDidClick() {
                return atom.restartApplication();
              }
            }];
            atom.notifications.addSuccess(message, { dismissable: true, buttons: buttons });
          }

          if (successfulUpdatesCount === totalUpdatesCount) {
            _this4.refs.checkButton.disabled = false;
            _this4.refs.updateAllButton.style.display = 'none';
          } else {
            // Some updates failed
            _this4.refs.checkButton.disabled = false;
            _this4.refs.updateAllButton.disabled = false;
          }
        }
      };

      var onUpdateResolved = function onUpdateResolved() {
        remainingPackagesCount--;
        successfulUpdatesCount++;
        notifyIfDone();
      };

      var onUpdateRejected = function onUpdateRejected() {
        remainingPackagesCount--;
        notifyIfDone();
      };

      for (var packageCard of this.packageCards) {
        if (!this.updatingPackages.includes(packageCard.pack)) {
          packageCard.update().then(onUpdateResolved, onUpdateRejected);
        } else {
          remainingPackagesCount--;
          totalUpdatesCount--;
        }
      }
    }
  }, {
    key: 'clearPackageCards',
    value: function clearPackageCards() {
      var packageCard = null;
      while (packageCard = this.packageCards.pop()) {
        packageCard.destroy();
      }
    }
  }, {
    key: 'scrollUp',
    value: function scrollUp() {
      this.element.scrollTop -= document.body.offsetHeight / 20;
    }
  }, {
    key: 'scrollDown',
    value: function scrollDown() {
      this.element.scrollTop += document.body.offsetHeight / 20;
    }
  }, {
    key: 'pageUp',
    value: function pageUp() {
      this.element.scrollTop -= this.element.offsetHeight;
    }
  }, {
    key: 'pageDown',
    value: function pageDown() {
      this.element.scrollTop += this.element.offsetHeight;
    }
  }, {
    key: 'scrollToTop',
    value: function scrollToTop() {
      this.element.scrollTop = 0;
    }
  }, {
    key: 'scrollToBottom',
    value: function scrollToBottom() {
      this.element.scrollTop = this.element.scrollHeight;
    }
  }]);

  return UpdatesPanel;
})();

exports['default'] = UpdatesPanel;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vQzovcHJvamVjdHMvYXRvbS9vdXQvYXBwL25vZGVfbW9kdWxlcy9zZXR0aW5ncy12aWV3L2xpYi91cGRhdGVzLXBhbmVsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztvQkFHa0MsTUFBTTs7b0JBQ3ZCLE1BQU07Ozs7eUJBRUQsY0FBYzs7OzsyQkFDWixnQkFBZ0I7Ozs7SUFFbkIsWUFBWTtBQUNuQixXQURPLFlBQVksQ0FDbEIsWUFBWSxFQUFFLGNBQWMsRUFBRTs7OzBCQUR4QixZQUFZOztBQUU3QixRQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQTtBQUNoQyxRQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQTtBQUNwQyxRQUFJLENBQUMsV0FBVyxHQUFHLCtCQUF5QixDQUFBO0FBQzVDLFFBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUE7QUFDMUIsUUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUE7O0FBRXRCLHNCQUFLLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTs7QUFFckIsUUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUE7QUFDaEQsUUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFBOztBQUV0QixRQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO0FBQ25ELG9CQUFjLEVBQUUsc0JBQU07QUFBRSxjQUFLLFFBQVEsRUFBRSxDQUFBO09BQUU7QUFDekMsc0JBQWdCLEVBQUUsd0JBQU07QUFBRSxjQUFLLFVBQVUsRUFBRSxDQUFBO09BQUU7QUFDN0Msb0JBQWMsRUFBRSxzQkFBTTtBQUFFLGNBQUssTUFBTSxFQUFFLENBQUE7T0FBRTtBQUN2QyxzQkFBZ0IsRUFBRSx3QkFBTTtBQUFFLGNBQUssUUFBUSxFQUFFLENBQUE7T0FBRTtBQUMzQyx3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QyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtTQUM5RCxNQUFNO0FBQ0wsZ0NBQXNCLEVBQUUsQ0FBQTtBQUN4QiwyQkFBaUIsRUFBRSxDQUFBO1NBQ3BCO09BQ0Y7S0FDRjs7O1dBRWlCLDZCQUFHO0FBQ25CLFVBQUksV0FBVyxHQUFHLElBQUksQ0FBQTtBQUN0QixhQUFPLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxFQUFFO0FBQzVDLG1CQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7T0FDdEI7S0FDRjs7O1dBRVEsb0JBQUc7QUFDVixVQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUE7S0FDMUQ7OztXQUVVLHNCQUFHO0FBQ1osVUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFBO0tBQzFEOzs7V0FFTSxrQkFBRztBQUNSLFVBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFBO0tBQ3BEOzs7V0FFUSxvQkFBRztBQUNWLFVBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFBO0tBQ3BEOzs7V0FFVyx1QkFBRztBQUNiLFVBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQTtLQUMzQjs7O1dBRWMsMEJBQUc7QUFDaEIsVUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUE7S0FDbkQ7OztTQXBPa0IsWUFBWTs7O3FCQUFaLFlBQVkiLCJmaWxlIjoiZmlsZTovLy9DOi9wcm9qZWN0cy9hdG9tL291dC9hcHAvbm9kZV9tb2R1bGVzL3NldHRpbmdzLXZpZXcvbGliL3VwZGF0ZXMtcGFuZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogQGJhYmVsICovXG4vKiogQGpzeCBldGNoLmRvbSAqL1xuXG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gJ2F0b20nXG5pbXBvcnQgZXRjaCBmcm9tICdldGNoJ1xuXG5pbXBvcnQgRXJyb3JWaWV3IGZyb20gJy4vZXJyb3ItdmlldydcbmltcG9ydCBQYWNrYWdlQ2FyZCBmcm9tICcuL3BhY2thZ2UtY2FyZCdcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVXBkYXRlc1BhbmVsIHtcbiAgY29uc3RydWN0b3IgKHNldHRpbmdzVmlldywgcGFja2FnZU1hbmFnZXIpIHtcbiAgICB0aGlzLnNldHRpbmdzVmlldyA9IHNldHRpbmdzVmlld1xuICAgIHRoaXMucGFja2FnZU1hbmFnZXIgPSBwYWNrYWdlTWFuYWdlclxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy51cGRhdGluZ1BhY2thZ2VzID0gW11cbiAgICB0aGlzLnBhY2thZ2VDYXJkcyA9IFtdXG5cbiAgICBldGNoLmluaXRpYWxpemUodGhpcylcblxuICAgIHRoaXMucmVmcy51cGRhdGVBbGxCdXR0b24uc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuICAgIHRoaXMuY2hlY2tGb3JVcGRhdGVzKClcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGF0b20uY29tbWFuZHMuYWRkKHRoaXMuZWxlbWVudCwge1xuICAgICAgJ2NvcmU6bW92ZS11cCc6ICgpID0+IHsgdGhpcy5zY3JvbGxVcCgpIH0sXG4gICAgICAnY29yZTptb3ZlLWRvd24nOiAoKSA9PiB7IHRoaXMuc2Nyb2xsRG93bigpIH0sXG4gICAgICAnY29yZTpwYWdlLXVwJzogKCkgPT4geyB0aGlzLnBhZ2VVcCgpIH0sXG4gICAgICAnY29yZTpwYWdlLWRvd24nOiAoKSA9PiB7IHRoaXMucGFnZURvd24oKSB9LFxuICAgICAgJ2NvcmU6bW92ZS10by10b3AnOiAoKSA9PiB7IHRoaXMuc2Nyb2xsVG9Ub3AoKSB9LFxuICAgICAgJ2NvcmU6bW92ZS10by1ib3R0b20nOiAoKSA9PiB7IHRoaXMuc2Nyb2xsVG9Cb3R0b20oKSB9XG4gICAgfSkpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnBhY2thZ2VNYW5hZ2VyLm9uKCdwYWNrYWdlLXVwZGF0aW5nIHRoZW1lLXVwZGF0aW5nJywgKHtwYWNrLCBlcnJvcn0pID0+IHtcbiAgICAgIHRoaXMucmVmcy5jaGVja0J1dHRvbi5kaXNhYmxlZCA9IHRydWVcbiAgICAgIHRoaXMudXBkYXRpbmdQYWNrYWdlcy5wdXNoKHBhY2spXG4gICAgfSkpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIHRoaXMucGFja2FnZU1hbmFnZXIub24oJ3BhY2thZ2UtdXBkYXRlZCB0aGVtZS11cGRhdGVkIHBhY2thZ2UtdXBkYXRlLWZhaWxlZCB0aGVtZS11cGRhdGUtZmFpbGVkJywgKHtwYWNrLCBlcnJvcn0pID0+IHtcbiAgICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgICAgICB0aGlzLnJlZnMudXBkYXRlRXJyb3JzLmFwcGVuZENoaWxkKG5ldyBFcnJvclZpZXcodGhpcy5wYWNrYWdlTWFuYWdlciwgZXJyb3IpLmVsZW1lbnQpXG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudXBkYXRpbmdQYWNrYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IHVwZGF0ZSA9IHRoaXMudXBkYXRpbmdQYWNrYWdlc1tpXVxuICAgICAgICAgIGlmICh1cGRhdGUubmFtZSA9PT0gcGFjay5uYW1lKSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0aW5nUGFja2FnZXMuc3BsaWNlKGksIDEpXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLnVwZGF0aW5nUGFja2FnZXMubGVuZ3RoKSB7XG4gICAgICAgICAgdGhpcy5yZWZzLmNoZWNrQnV0dG9uLmRpc2FibGVkID0gZmFsc2VcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApXG4gIH1cblxuICBkZXN0cm95ICgpIHtcbiAgICB0aGlzLmNsZWFyUGFja2FnZUNhcmRzKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHJldHVybiBldGNoLmRlc3Ryb3kodGhpcylcbiAgfVxuXG4gIHVwZGF0ZSAoKSB7fVxuXG4gIHJlbmRlciAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXYgdGFiSW5kZXg9JzAnIGNsYXNzTmFtZT0ncGFuZWxzLWl0ZW0nPlxuICAgICAgICA8c2VjdGlvbiBjbGFzc05hbWU9J3NlY3Rpb24gcGFja2FnZXMnPlxuICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uLWNvbnRhaW5lciB1cGRhdGVzLWNvbnRhaW5lcic+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ndXBkYXRlcy1oZWFkaW5nLWNvbnRhaW5lcic+XG4gICAgICAgICAgICAgIDxoMSBjbGFzc05hbWU9J3NlY3Rpb24taGVhZGluZyBpY29uIGljb24tY2xvdWQtZG93bmxvYWQnPkF2YWlsYWJsZSBVcGRhdGVzPC9oMT5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24taGVhZGluZyB1cGRhdGVzLWJ0bi1ncm91cCc+XG4gICAgICAgICAgICAgICAgPGJ1dHRvblxuICAgICAgICAgICAgICAgICAgcmVmPSd1cGRhdGVBbGxCdXR0b24nXG4gICAgICAgICAgICAgICAgICBjbGFzc05hbWU9J3B1bGwtcmlnaHQgdXBkYXRlLWFsbC1idXR0b24gYnRuIGJ0bi1wcmltYXJ5J1xuICAgICAgICAgICAgICAgICAgb25jbGljaz17KCkgPT4geyB0aGlzLnVwZGF0ZUFsbCgpIH19PlVwZGF0ZSBBbGw8L2J1dHRvbj5cbiAgICAgICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgICAgICByZWY9J2NoZWNrQnV0dG9uJ1xuICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSdwdWxsLXJpZ2h0IHVwZGF0ZS1hbGwtYnV0dG9uIGJ0biBidG4nXG4gICAgICAgICAgICAgICAgICBvbmNsaWNrPXsoKSA9PiB7IHRoaXMuY2hlY2tGb3JVcGRhdGVzKHRydWUpIH19PkNoZWNrIGZvciBVcGRhdGVzPC9idXR0b24+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICAgIDxkaXYgcmVmPSd1cGRhdGVFcnJvcnMnPjwvZGl2PlxuICAgICAgICAgICAgPGRpdiByZWY9J2NoZWNraW5nTWVzc2FnZScgY2xhc3NOYW1lPSdhbGVydCBhbGVydC1pbmZvIGljb24gaWNvbi1ob3VyZ2xhc3MnPntgQ2hlY2tpbmcgZm9yIHVwZGF0ZXNcXHUyMDI2YH08L2Rpdj5cbiAgICAgICAgICAgIDxkaXYgcmVmPSdub1VwZGF0ZXNNZXNzYWdlJyBjbGFzc05hbWU9J2FsZXJ0IGFsZXJ0LWluZm8gaWNvbiBpY29uLWhlYXJ0Jz5BbGwgb2YgeW91ciBpbnN0YWxsZWQgcGFja2FnZXMgYXJlIHVwIHRvIGRhdGUhPC9kaXY+XG4gICAgICAgICAgICA8ZGl2IHJlZj0ndXBkYXRlc0NvbnRhaW5lcicgY2xhc3NOYW1lPSdjb250YWluZXIgcGFja2FnZS1jb250YWluZXInPjwvZGl2PlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L3NlY3Rpb24+XG4gICAgICA8L2Rpdj5cbiAgICApXG4gIH1cblxuICBmb2N1cyAoKSB7XG4gICAgdGhpcy5lbGVtZW50LmZvY3VzKClcbiAgfVxuXG4gIHNob3cgKCkge1xuICAgIHRoaXMuZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJydcbiAgfVxuXG4gIGJlZm9yZVNob3cgKG9wdHMpIHtcbiAgICBpZiAob3B0cyAmJiBvcHRzLmJhY2spIHtcbiAgICAgIHRoaXMucmVmcy5icmVhZGNydW1iLnRleHRDb250ZW50ID0gb3B0cy5iYWNrXG4gICAgICB0aGlzLnJlZnMuYnJlYWRjcnVtYi5vbmNsaWNrID0gKCkgPT4geyB0aGlzLnNldHRpbmdzVmlldy5zaG93UGFuZWwob3B0cy5iYWNrKSB9XG4gICAgfVxuXG4gICAgaWYgKG9wdHMgJiYgb3B0cy51cGRhdGVzKSB7XG4gICAgICB0aGlzLmF2YWlsYWJsZVVwZGF0ZXMgPSBvcHRzLnVwZGF0ZXNcbiAgICAgIHRoaXMuYWRkVXBkYXRlVmlld3MoKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmF2YWlsYWJsZVVwZGF0ZXMgPSBbXVxuICAgICAgdGhpcy5jbGVhclBhY2thZ2VDYXJkcygpXG4gICAgICB0aGlzLmNoZWNrRm9yVXBkYXRlcygpXG4gICAgfVxuICB9XG5cbiAgLy8gQ2hlY2sgZm9yIHVwZGF0ZXMgYW5kIGRpc3BsYXkgdGhlbVxuICBhc3luYyBjaGVja0ZvclVwZGF0ZXMgKGNsZWFyQ2FjaGUpIHtcbiAgICB0aGlzLnJlZnMubm9VcGRhdGVzTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnXG4gICAgdGhpcy5yZWZzLnVwZGF0ZUFsbEJ1dHRvbi5kaXNhYmxlZCA9IHRydWVcbiAgICB0aGlzLnJlZnMuY2hlY2tCdXR0b24uZGlzYWJsZWQgPSB0cnVlXG4gICAgdGhpcy5yZWZzLmNoZWNraW5nTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJydcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmF2YWlsYWJsZVVwZGF0ZXMgPSBhd2FpdCB0aGlzLnBhY2thZ2VNYW5hZ2VyLmdldE91dGRhdGVkKGNsZWFyQ2FjaGUpXG4gICAgICB0aGlzLnJlZnMuY2hlY2tCdXR0b24uZGlzYWJsZWQgPSBmYWxzZVxuICAgICAgdGhpcy5hZGRVcGRhdGVWaWV3cygpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMucmVmcy5jaGVja0J1dHRvbi5kaXNhYmxlZCA9IGZhbHNlXG4gICAgICB0aGlzLnJlZnMuY2hlY2tpbmdNZXNzYWdlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICAgIHRoaXMucmVmcy51cGRhdGVFcnJvcnMuYXBwZW5kQ2hpbGQobmV3IEVycm9yVmlldyh0aGlzLnBhY2thZ2VNYW5hZ2VyLCBlcnJvcikuZWxlbWVudClcbiAgICB9XG4gIH1cblxuICBhZGRVcGRhdGVWaWV3cyAoKSB7XG4gICAgaWYgKHRoaXMuYXZhaWxhYmxlVXBkYXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnJlZnMudXBkYXRlQWxsQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAnJ1xuICAgICAgdGhpcy5yZWZzLnVwZGF0ZUFsbEJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlXG4gICAgfVxuICAgIHRoaXMucmVmcy5jaGVja2luZ01lc3NhZ2Uuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuICAgIHRoaXMuY2xlYXJQYWNrYWdlQ2FyZHMoKVxuICAgIGlmICh0aGlzLmF2YWlsYWJsZVVwZGF0ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLnJlZnMubm9VcGRhdGVzTWVzc2FnZS5zdHlsZS5kaXNwbGF5ID0gJydcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHBhY2sgb2YgdGhpcy5hdmFpbGFibGVVcGRhdGVzKSB7XG4gICAgICBjb25zdCBwYWNrYWdlQ2FyZCA9IG5ldyBQYWNrYWdlQ2FyZChwYWNrLCB0aGlzLnNldHRpbmdzVmlldywgdGhpcy5wYWNrYWdlTWFuYWdlciwge2JhY2s6ICdVcGRhdGVzJ30pXG4gICAgICB0aGlzLnJlZnMudXBkYXRlc0NvbnRhaW5lci5hcHBlbmRDaGlsZChwYWNrYWdlQ2FyZC5lbGVtZW50KVxuICAgICAgdGhpcy5wYWNrYWdlQ2FyZHMucHVzaChwYWNrYWdlQ2FyZClcbiAgICB9XG4gIH1cblxuICB1cGRhdGVBbGwgKCkge1xuICAgIHRoaXMucmVmcy5jaGVja0J1dHRvbi5kaXNhYmxlZCA9IHRydWVcbiAgICB0aGlzLnJlZnMudXBkYXRlQWxsQnV0dG9uLmRpc2FibGVkID0gdHJ1ZVxuXG4gICAgbGV0IHN1Y2Nlc3NmdWxVcGRhdGVzQ291bnQgPSAwXG4gICAgbGV0IHJlbWFpbmluZ1BhY2thZ2VzQ291bnQgPSB0aGlzLnBhY2thZ2VDYXJkcy5sZW5ndGhcbiAgICBsZXQgdG90YWxVcGRhdGVzQ291bnQgPSB0aGlzLnBhY2thZ2VDYXJkcy5sZW5ndGggLy8gVGhpcyB2YWx1ZSBkb2Vzbid0IGNoYW5nZSB1bmxpa2UgcmVtYWluaW5nUGFja2FnZXNDb3VudFxuXG4gICAgY29uc3Qgbm90aWZ5SWZEb25lID0gKCkgPT4ge1xuICAgICAgaWYgKHJlbWFpbmluZ1BhY2thZ2VzQ291bnQgPT09IDApIHtcbiAgICAgICAgaWYgKHN1Y2Nlc3NmdWxVcGRhdGVzQ291bnQgPiAwKSB7XG4gICAgICAgICAgbGV0IHBsdXJhbGl6ZWRQYWNrYWdlcyA9ICdwYWNrYWdlJ1xuICAgICAgICAgIGlmIChzdWNjZXNzZnVsVXBkYXRlc0NvdW50ID4gMSkge1xuICAgICAgICAgICAgcGx1cmFsaXplZFBhY2thZ2VzICs9ICdzJ1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYFJlc3RhcnQgQXRvbSB0byBjb21wbGV0ZSB0aGUgdXBkYXRlIG9mICR7c3VjY2Vzc2Z1bFVwZGF0ZXNDb3VudH0gJHtwbHVyYWxpemVkUGFja2FnZXN9LmBcblxuICAgICAgICAgIGNvbnN0IGJ1dHRvbnMgPSBbe1xuICAgICAgICAgICAgdGV4dDogJ1Jlc3RhcnQnLFxuICAgICAgICAgICAgb25EaWRDbGljaygpIHsgcmV0dXJuIGF0b20ucmVzdGFydEFwcGxpY2F0aW9uKCkgfVxuICAgICAgICAgIH1dXG4gICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MobWVzc2FnZSwge2Rpc21pc3NhYmxlOiB0cnVlLCBidXR0b25zfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdWNjZXNzZnVsVXBkYXRlc0NvdW50ID09PSB0b3RhbFVwZGF0ZXNDb3VudCkge1xuICAgICAgICAgIHRoaXMucmVmcy5jaGVja0J1dHRvbi5kaXNhYmxlZCA9IGZhbHNlXG4gICAgICAgICAgdGhpcy5yZWZzLnVwZGF0ZUFsbEJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnXG4gICAgICAgIH0gZWxzZSB7IC8vIFNvbWUgdXBkYXRlcyBmYWlsZWRcbiAgICAgICAgICB0aGlzLnJlZnMuY2hlY2tCdXR0b24uZGlzYWJsZWQgPSBmYWxzZVxuICAgICAgICAgIHRoaXMucmVmcy51cGRhdGVBbGxCdXR0b24uZGlzYWJsZWQgPSBmYWxzZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgb25VcGRhdGVSZXNvbHZlZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmVtYWluaW5nUGFja2FnZXNDb3VudC0tXG4gICAgICBzdWNjZXNzZnVsVXBkYXRlc0NvdW50KytcbiAgICAgIG5vdGlmeUlmRG9uZSgpXG4gICAgfVxuXG4gICAgY29uc3Qgb25VcGRhdGVSZWplY3RlZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmVtYWluaW5nUGFja2FnZXNDb3VudC0tXG4gICAgICBub3RpZnlJZkRvbmUoKVxuICAgIH1cblxuICAgIGZvciAoY29uc3QgcGFja2FnZUNhcmQgb2YgdGhpcy5wYWNrYWdlQ2FyZHMpIHtcbiAgICAgIGlmICghdGhpcy51cGRhdGluZ1BhY2thZ2VzLmluY2x1ZGVzKHBhY2thZ2VDYXJkLnBhY2spKSB7XG4gICAgICAgIHBhY2thZ2VDYXJkLnVwZGF0ZSgpLnRoZW4ob25VcGRhdGVSZXNvbHZlZCwgb25VcGRhdGVSZWplY3RlZClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlbWFpbmluZ1BhY2thZ2VzQ291bnQtLVxuICAgICAgICB0b3RhbFVwZGF0ZXNDb3VudC0tXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY2xlYXJQYWNrYWdlQ2FyZHMgKCkge1xuICAgIGxldCBwYWNrYWdlQ2FyZCA9IG51bGxcbiAgICB3aGlsZSAocGFja2FnZUNhcmQgPSB0aGlzLnBhY2thZ2VDYXJkcy5wb3AoKSkge1xuICAgICAgcGFja2FnZUNhcmQuZGVzdHJveSgpXG4gICAgfVxuICB9XG5cbiAgc2Nyb2xsVXAgKCkge1xuICAgIHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgLT0gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQgLyAyMFxuICB9XG5cbiAgc2Nyb2xsRG93biAoKSB7XG4gICAgdGhpcy5lbGVtZW50LnNjcm9sbFRvcCArPSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodCAvIDIwXG4gIH1cblxuICBwYWdlVXAgKCkge1xuICAgIHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgLT0gdGhpcy5lbGVtZW50Lm9mZnNldEhlaWdodFxuICB9XG5cbiAgcGFnZURvd24gKCkge1xuICAgIHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgKz0gdGhpcy5lbGVtZW50Lm9mZnNldEhlaWdodFxuICB9XG5cbiAgc2Nyb2xsVG9Ub3AgKCkge1xuICAgIHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgPSAwXG4gIH1cblxuICBzY3JvbGxUb0JvdHRvbSAoKSB7XG4gICAgdGhpcy5lbGVtZW50LnNjcm9sbFRvcCA9IHRoaXMuZWxlbWVudC5zY3JvbGxIZWlnaHRcbiAgfVxufVxuIl19